<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor MEI - Sistema Completo V12.13</title>
    
    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Folha de Estilos -->
    <link rel="stylesheet" href="style.css?v=12.13">
</head>
<body>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay">
        <div class="loader"></div>
        <p>Carregando Gestor MEI...</p>
    </div>

    <!-- TELA DE AUTENTICA√á√ÉO -->
    <div id="auth-screen">
        <div class="auth-card">
            <h2 class="text-center" style="margin-bottom: 1.5rem;">Gestor MEI</h2>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="E-mail" required>
                <input type="password" id="login-password" placeholder="Senha" required>
                <button type="submit" class="btn-primary w-full">Entrar</button>
                <div class="mt-4 flex flex-col gap-2">
                    <button type="button" class="btn-outline w-full" onclick="toggleAuth('register')">Criar Conta (30 dias gr√°tis)</button>
                    <!-- Integra√ß√£o Google -->
                    <button type="button" class="google-btn w-full" onclick="handleGoogleLogin()">Entrar com Google</button>
                    <a href="#" onclick="alert('Simula√ß√£o: Link de recupera√ß√£o enviado para o e-mail!')" class="text-center text-sm text-primary mt-2">Esqueci minha senha</a>
                </div>
            </form>
            <form id="register-form" class="hidden">
                <input type="text" id="reg-name" placeholder="Seu Nome Completo" required>
                <input type="email" id="reg-email" placeholder="E-mail" required>
                <input type="password" id="reg-password" placeholder="Senha" required>
                <button type="submit" class="btn-success w-full">Cadastrar e Ganhar 30 Dias</button>
                <button type="button" class="btn-outline w-full mt-4" onclick="toggleAuth('login')">Voltar para Login</button>
            </form>
        </div>
    </div>

    <!-- APLICA√á√ÉO PRINCIPAL -->
    <div id="app-container" class="hidden">
        
        <!-- BARRA LATERAL (MENU) -->
        <aside>
            <h2>Gestor MEI</h2>
            <nav class="flex-col flex w-full">
                <div class="nav-item active" onclick="navTo('dashboard')">üìä Dashboard</div>
                <div class="nav-item" onclick="navTo('agenda')">üìÖ Agenda</div>
                <div class="nav-item" onclick="navTo('lembretes')">üîî Lembretes</div> 
                <div class="nav-item" onclick="navTo('cadastros')">üßæ Cadastros</div>
                <div class="nav-item" onclick="navTo('financeiro')">üí∞ Financeiro</div>
                <div class="nav-item" onclick="navTo('rpa')">üìÑ Gerador RPA</div>
                <div class="nav-item" onclick="navTo('fiscal')">üè¢ Fiscal & IRRF</div>
                <div class="nav-item" onclick="navTo('listagens')">üìë Listagens</div>
                <div class="nav-item" onclick="navTo('configuracoes')">‚öôÔ∏è Configura√ß√µes</div>
            </nav>
            <div class="user-info">
                <p>
                    <span id="sync-indicator" class="sync-status sync-offline" title="Offline / Local"></span>
                    <span id="user-name-display">Usu√°rio</span>
                </p>
                <button class="btn-sync" onclick="manualSync()">üîÑ Sincronizar</button>
                <p id="license-days-display" class="text-success text-sm mt-2">Licen√ßa Ativa</p>
                <button onclick="logout()" class="text-danger text-sm mt-2 w-full text-left" style="background: rgba(220, 38, 38, 0.1); border-radius: 4px; padding: 0.5rem; text-align: center;">üö™ Sair / Logout</button>
            </div>
        </aside>

        <!-- √ÅREA PRINCIPAL DE CONTE√öDO -->
        <main>
            <div id="license-warning" class="notification-bar hidden">Sua licen√ßa expirou! Contate o administrador.</div>

            <!-- VIEW: DASHBOARD -->
            <section id="view-dashboard">
                <div class="view-header"><h1>Vis√£o Geral</h1></div>
                <div class="dash-grid">
                    <div class="stat-card"><h3>Receitas (M√™s)</h3><div class="stat-value text-success" id="dash-income">R$ 0,00</div></div>
                    <div class="stat-card"><h3>Despesas (M√™s)</h3><div class="stat-value text-danger" id="dash-expense">R$ 0,00</div></div>
                    <div class="stat-card"><h3>Saldo</h3><div class="stat-value" id="dash-balance">R$ 0,00</div></div>
                </div>
                <div class="dash-grid mt-4">
                    <div class="stat-card" style="border-left: 4px solid var(--info);">
                        <h3>Reserva (<span id="reserve-percent-display">10</span>%)</h3>
                        <div class="stat-value text-info" id="dash-reserve">R$ 0,00</div>
                        <div class="stat-sub">Acumulado das Entradas</div>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid var(--warning);">
                        <h3>Pr√≥-labore (M√™s)</h3>
                        <div class="stat-value text-warning" id="dash-prolabore">R$ 0,00</div>
                        <div class="stat-sub">Meta: <span id="dash-prolabore-target">R$ 0,00</span></div>
                    </div>
                </div>
                <div class="mt-4 flex gap-4 flex-col md:flex-row">
                    <div class="stat-card w-full"><h3>üìÖ Pr√≥ximos Compromissos Fiscais</h3><ul id="fiscal-reminders" class="mt-4" style="list-style: none;"></ul></div>
                    <div class="stat-card w-full"><h3>üìÇ Acesso R√°pido</h3><p class="mb-4">Relat√≥rios e Listagens.</p><button class="btn-info w-full" onclick="navTo('listagens')">Ver Listagens</button></div>
                </div>
            </section>

            <!-- VIEW: AGENDA -->
            <section id="view-agenda" class="hidden">
                <div class="view-header flex justify-between items-center">
                    <h1>Agenda de Compromissos</h1>
                    <button class="btn-primary" onclick="openAppointmentModal()">+ Novo Agendamento</button>
                </div>
                <div class="flex gap-2 mb-4">
                    <input type="date" id="agenda-filter-date" onchange="renderAgenda()" style="max-width: 200px; margin:0;">
                    <button class="btn-outline" onclick="renderAgenda('all')">Ver Todos</button>
                    <button class="btn-outline" onclick="renderAgenda('today')">Hoje</button>
                </div>
                <div id="agenda-list" class="dash-grid"></div>
            </section>

            <!-- VIEW: LEMBRETES -->
            <section id="view-lembretes" class="hidden">
                <div class="view-header"><h1>Gerenciamento de Lembretes</h1></div>
                
                <div class="stat-card mb-4">
                    <h3 id="rem-form-title">üîî Novo Lembrete</h3>
                    <form onsubmit="saveReminder(event)">
                        <input type="hidden" id="rem-id">
                        
                        <label>T√≠tulo do Lembrete</label>
                        <input type="text" id="rem-title" placeholder="Ex: Pagar Boleto" required>
                        
                        <div class="flex gap-2">
                            <div class="w-full">
                                <label>Data e Hor√°rio</label>
                                <input type="datetime-local" id="rem-datetime" required>
                            </div>
                            <div class="w-full">
                                <label>Periodicidade</label>
                                <select id="rem-period">
                                    <option value="once">Uma vez</option>
                                    <option value="hourly">Hor√°rio</option>
                                    <option value="daily">Di√°rio</option>
                                    <option value="weekly">Semanal</option>
                                    <option value="biweekly">Quinzenal</option>
                                    <option value="monthly">Mensal</option>
                                    <option value="yearly">Anual</option>
                                </select>
                            </div>
                        </div>

                        <label>E-mail de Destino</label>
                        <input type="email" id="rem-email" placeholder="seu@email.com" required>

                        <label>Texto da Mensagem</label>
                        <textarea id="rem-msg" rows="3" required></textarea>

                        <div class="flex gap-2 items-center mt-2 mb-2">
                            <input type="checkbox" id="rem-immediate" style="width:auto; margin-bottom:0;">
                            <label for="rem-immediate" style="margin-top:0; margin-bottom:0;">Enviar imediatamente</label>
                        </div>

                        <div class="flex gap-2 mt-2">
                            <button type="submit" class="btn-primary w-full" id="rem-btn-save">Salvar Lembrete</button>
                            <button type="button" class="btn-outline hidden" id="rem-btn-cancel" onclick="cancelReminderEdit()">Cancelar</button>
                        </div>
                    </form>
                </div>

                <div class="stat-card">
                    <h4>Lembretes Configurados</h4>
                    <p class="text-sm text-light mb-2">Envios autom√°ticos gerenciados pelo sistema.</p>
                    <div class="table-container mt-2">
                        <table id="reminders-table">
                            <thead><tr><th>T√≠tulo</th><th>Pr√≥ximo Disparo</th><th>Repeti√ß√£o</th><th>A√ß√µes</th></tr></thead>
                            <tbody id="reminders-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- VIEW: LISTAGENS -->
            <section id="view-listagens" class="hidden">
                <div class="view-header flex justify-between items-center">
                    <h1>Relat√≥rios</h1>
                    <div class="no-print">
                        <button class="btn-primary" onclick="exportReportPDF()">üñ®Ô∏è PDF</button>
                        <button class="btn-info" onclick="exportReportDoc()">üìÑ Word</button>
                    </div>
                </div>
                <div class="tabs no-print">
                    <button class="tab-btn active" onclick="switchListing('clients')">Clientes</button>
                    <button class="tab-btn" onclick="switchListing('suppliers')">Fornecedores</button>
                    <button class="tab-btn" onclick="switchListing('products')">Produtos</button>
                    <button class="tab-btn" onclick="switchListing('services')">Servi√ßos</button>
                    <button class="tab-btn" onclick="switchListing('movimentacoes')">Movimenta√ß√µes</button>
                </div>
                <div id="movements-filter" class="stat-card mb-4 hidden no-print">
                    <label>Filtrar por M√™s e Ano:</label>
                    <div class="flex gap-2">
                        <input type="month" id="listing-month-filter" onchange="renderListingTable()">
                        <button class="btn-outline" style="width: auto;" onclick="renderListingTable()">Filtrar</button>
                    </div>
                </div>
                <div class="table-container" id="report-print-area">
                    <h3 id="report-company-header" class="text-center mb-4" style="text-transform: uppercase;"></h3>
                    <h3 id="report-title" class="hidden text-center">Relat√≥rio</h3>
                    <table id="listing-table"><thead id="listing-thead"></thead><tbody id="listing-tbody"></tbody></table>
                </div>
            </section>

            <!-- VIEW: FINANCEIRO -->
            <section id="view-financeiro" class="hidden">
                <div class="view-header flex justify-between items-center">
                    <h1>Movimenta√ß√µes Financeiras</h1>
                    <button class="btn-primary" onclick="openTransactionModal()">+ Novo Lan√ßamento</button>
                </div>
                <div class="flex gap-4 mb-4">
                    <button class="btn-outline fin-filter-btn active" onclick="filterFinance('all')">Todos</button>
                    <button class="btn-outline fin-filter-btn" onclick="filterFinance('receita')">Entradas</button>
                    <button class="btn-outline fin-filter-btn" onclick="filterFinance('despesa')">Sa√≠das</button>
                </div>
                <div class="table-container">
                    <table id="finance-table">
                        <thead><tr><th>Data</th><th>Tipo</th><th>Categoria</th><th>Descri√ß√£o</th><th>Valor</th><th>A√ß√µes</th></tr></thead><tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- VIEW: RPA -->
            <section id="view-rpa" class="hidden">
                <div class="view-header no-print"><h1>Gerador de RPA</h1></div>
                <div class="stat-card mb-4 no-print">
                    <div class="flex gap-4 flex-col md:flex-row">
                        <div class="w-full">
                            <h3 class="mb-2">Automa√ß√£o</h3>
                            <label>Selecione o Aut√¥nomo:</label>
                            <select id="rpa-provider-select" onchange="fillRPAProvider()"><option value="">Selecione...</option></select>
                        </div>
                        <div class="w-full">
                            <h3 class="mb-2">A√ß√µes</h3>
                            <div class="flex gap-2 mb-2">
                                <button class="btn-success w-full" onclick="saveRPA()">üíæ Salvar RPA</button>
                                <button class="btn-warning w-full" onclick="toggleRPAHistory()">üìú Hist√≥rico</button>
                            </div>
                            <div class="flex gap-2 mb-2">
                                <button class="btn-primary w-full" onclick="exportRPAPdf()">üñ®Ô∏è PDF</button>
                                <button class="btn-info w-full" onclick="exportRPADoc()">üìÑ Word</button>
                            </div>
                            <button class="btn-outline w-full" onclick="sendRPAEmail()">üìß Enviar por E-mail (com Anexo)</button>
                        </div>
                    </div>
                    <div id="rpa-history-container" class="hidden mt-4 border-t pt-4">
                        <h4>Recibos Salvos</h4>
                        <div class="table-container">
                            <table id="rpa-history-table"><thead><tr><th>Data</th><th>Aut√¥nomo</th><th>Valor L√≠quido</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
                        </div>
                    </div>
                </div>

                <div class="rpa-paper" id="rpa-content">
                    <h2 class="text-center mb-4" style="text-decoration: underline;">RECIBO DE PAGAMENTO A AUT√îNOMO (RPA)</h2>
                    <input type="hidden" id="rpa-id">
                    <div class="rpa-section">
                        <h4>1. Contratante (Empresa)</h4>
                        <label>Raz√£o Social:</label><input type="text" id="rpa-comp-name">
                        <div class="flex gap-2"><div class="w-full"><label>CNPJ:</label><input type="text" id="rpa-comp-cnpj"></div><div class="w-full"><label>Endere√ßo:</label><input type="text" id="rpa-comp-addr"></div></div>
                    </div>
                    <div class="rpa-section">
                        <h4>2. Aut√¥nomo (Prestador)</h4>
                        <label>Nome Completo:</label><input type="text" id="rpa-prov-name">
                        <div class="flex gap-2"><div class="w-full"><label>CPF:</label><input type="text" id="rpa-prov-cpf"></div><div class="w-full"><label>Telefone:</label><input type="text" id="rpa-prov-phone"></div></div>
                        <div class="w-full"><label>Email:</label><input type="email" id="rpa-prov-email" placeholder="email@exemplo.com"></div>
                        <label>Endere√ßo:</label><input type="text" id="rpa-prov-addr">
                    </div>
                    <div class="rpa-section">
                        <h4>3. Servi√ßo Prestado</h4>
                        <label>Descri√ß√£o:</label><input type="text" id="rpa-desc" placeholder="Ex: Consultoria">
                        <label>Data:</label><input type="date" id="rpa-date">
                    </div>
                    <div class="rpa-section">
                        <h4>4. Valor do Servi√ßo</h4>
                        <label>Valor Bruto (R$):</label><input type="number" id="rpa-value" step="0.01" oninput="calculateRPA()" placeholder="0,00">
                    </div>
                    <div class="rpa-section">
                        <h4>5. C√°lculo dos Descontos</h4>
                        <div class="flex gap-2">
                            <div class="w-full"><label>a) INSS (11%):</label><input type="text" id="rpa-inss" readonly></div>
                            <div class="w-full"><label>b) ISS (%: <input type="number" id="rpa-iss-rate" value="3" style="width:50px;display:inline;" oninput="calculateRPA()">):</label><input type="text" id="rpa-iss-val" readonly></div>
                        </div>
                        <label>c) IRRF:</label><input type="text" id="rpa-irrf" readonly>
                        <hr class="mt-2 mb-2">
                        <label style="font-size: 1.2rem; color: var(--primary);">‚û° Valor L√≠quido:</label>
                        <input type="text" id="rpa-net" readonly style="font-size: 1.5rem; font-weight: bold;">
                    </div>
                    <div class="rpa-section" style="border:none;">
                        <h4>6. Declara√ß√£o</h4>
                        <p style="text-align: justify; font-size: 0.9rem;">Declaro que prestei os servi√ßos acima descritos e recebi da contratante o valor l√≠quido correspondente, dando o presente recibo como pago e quitado.</p>
                        <br><br>
                        <div class="flex gap-4">
                            <div class="w-full text-center"><p>______________________________________</p><p><strong>Prestador</strong></p><p>Data: ____ / ____ / ______</p></div>
                            <div class="w-full text-center"><p>______________________________________</p><p><strong>Contratante</strong></p><p>Data: ____ / ____ / ______</p></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: CADASTROS -->
            <section id="view-cadastros" class="hidden">
                <div class="view-header"><h1>Cadastros</h1></div>
                <div class="flex gap-2 mb-4 overflow-x-auto">
                    <button class="btn-outline crud-btn" onclick="renderCrud('products')">Produtos</button>
                    <button class="btn-outline crud-btn" onclick="renderCrud('services')">Servi√ßos</button>
                    <button class="btn-outline crud-btn" onclick="renderCrud('clients')">Clientes</button>
                    <button class="btn-outline crud-btn" onclick="renderCrud('suppliers')">Fornecedores</button>
                </div>
                <div id="crud-area" class="stat-card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="crud-title">Itens</h3>
                        <button class="btn-primary" onclick="openCrudModal(false)">+ Adicionar</button>
                    </div>
                    <div class="table-container"><table id="crud-table"></table></div>
                </div>
            </section>

            <!-- VIEW: FISCAL -->
            <section id="view-fiscal" class="hidden">
                <div class="view-header"><h1>Fiscal & Obriga√ß√µes</h1></div>
                <div class="dash-grid">
                    <div class="stat-card text-center">
                        <h3>Emitir Nota Fiscal</h3>
                        <p class="text-sm text-light mb-4">Link Configurado</p>
                        <a id="link-emissor" href="#" target="_blank" class="btn-primary">Acessar Emissor</a>
                    </div>
                    <div class="stat-card">
                        <h3>DAS MEI</h3>
                        <p class="mb-2">Vencimento dia 20.</p>
                        <a id="link-das" href="#" target="_blank" class="btn-outline w-full text-center">Gerar Boleto DAS</a>
                    </div>
                </div>
                <div class="stat-card mt-4">
                    <div class="flex justify-between items-center mb-2"><h3>Tabela IRRF</h3><button class="btn-info action-btn" onclick="openIrrfModal()">+ Faixa</button></div>
                    <div class="table-container mt-2"><table id="irrf-table-display"><thead><tr><th>At√© Base (R$)</th><th>%</th><th>Dedu√ß√£o</th><th>X</th></tr></thead><tbody id="irrf-table-body"></tbody></table></div>
                </div>
            </section>

            <!-- VIEW: CONFIGURA√á√ïES -->
            <section id="view-configuracoes" class="hidden">
                <div class="view-header"><h1>Configura√ß√µes</h1></div>
                <div class="stat-card mb-4">
                    <h3>üè¢ Dados da Empresa & URLs</h3>
                    <form onsubmit="saveCompanyData(event)">
                        <label>Nome Fantasia</label><input type="text" id="conf-company-name" required>
                        <div class="flex gap-2">
                            <div class="w-full"><label>CNPJ</label><input type="text" id="conf-cnpj"></div>
                            <div class="w-full"><label>Telefone</label><input type="text" id="conf-phone"></div>
                        </div>
                        <label>Endere√ßo Completo</label><input type="text" id="conf-address">
                        <label>WhatsApp</label><input type="text" id="conf-whatsapp">
                        <label>E-mail do Aut√¥nomo</label><input type="email" id="conf-auth-email" placeholder="email@exemplo.com">
                        
                        <label>Atua√ß√£o</label>
                        <select id="conf-role">
                            <option value="both">Vendedor e Prestador</option>
                            <option value="seller">Vendedor</option>
                            <option value="provider">Prestador</option>
                        </select>
                        <hr class="mt-4 mb-4">
                        <h4>Par√¢metros Financeiros</h4>
                        <div class="flex gap-2">
                            <div class="w-full"><label>Percentual Reserva (%)</label><input type="number" id="conf-reserve-rate" step="0.1" placeholder="Sugest√£o: 10"></div>
                            <div class="w-full"><label>Meta Pr√≥-labore (R$)</label><input type="number" id="conf-prolabore-target" step="0.01" placeholder="Padr√£o: 4000.00"></div>
                        </div>
                        <hr class="mt-4 mb-4">
                        <h4>Links Externos</h4>
                        <label>URL Emissor Fiscal</label><input type="url" id="conf-url-fiscal" placeholder="Padr√£o do Governo...">
                        <label>URL Gera√ß√£o DAS</label><input type="url" id="conf-url-das" placeholder="Padr√£o do Governo...">
                        <button type="submit" class="btn-primary mt-2">Salvar Dados</button>
                    </form>
                </div>
                
                <!-- √ÅREA DE GEST√ÉO DE USU√ÅRIOS (RESTRICTED ID) -->
                <div id="admin-panel" class="stat-card mb-4 hidden">
                    <h3>üë• Gest√£o de Usu√°rios (Admin)</h3>
                    <p class="text-sm text-light mb-2">Acesso restrito a administradores.</p>
                    <button class="btn-info w-full" onclick="openUserManagementModal()">üìÇ Abrir Lista de Usu√°rios</button>
                </div>

                <div class="stat-card mb-4">
                    <h3>üíæ Backup & Sincroniza√ß√£o</h3>
                    <div class="flex gap-4 mt-2 items-center flex-wrap">
                        <button class="btn-info" onclick="downloadBackup()">üì• Backup (.json)</button>
                        <div class="flex flex-col"><label style="margin-top:0">Restaurar</label><input type="file" id="restore-file" accept=".json" onchange="restoreBackup(this)"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- MODAL: TRANSA√á√ÉO FINANCEIRA -->
    <div id="modal-transaction" class="modal-overlay hidden" onclick="if(event.target===this) closeModal('modal-transaction')">
        <div class="modal">
            <h2>Lan√ßamento Financeiro</h2>
            <form id="form-transaction" onsubmit="saveTransaction(event)">
                <input type="hidden" id="trans-id">
                <label>Tipo</label><select id="trans-type" onchange="updateTransactionDependencies()" required><option value="receita">Entrada</option><option value="despesa">Sa√≠da</option></select>
                <label>Categoria</label><select id="trans-category" required></select>
                <label>Valor</label><input type="number" id="trans-value" step="0.01" required>
                <label>Data</label><input type="date" id="trans-date" required>
                <label>Cliente/Fornecedor</label><select id="trans-entity"><option value="">Selecione...</option></select>
                <label>Descri√ß√£o</label><textarea id="trans-obs" rows="3"></textarea>
                <div class="flex gap-2 mt-4"><button type="button" class="btn-outline w-full" onclick="closeModal('modal-transaction')">Cancelar</button><button type="submit" class="btn-primary w-full">Salvar</button></div>
            </form>
        </div>
    </div>

    <!-- MODAL: CRUD GEN√âRICO -->
    <div id="modal-crud" class="modal-overlay hidden" onclick="if(event.target===this) closeModal('modal-crud')">
        <div class="modal">
            <h2 id="modal-crud-title">Item</h2>
            <form id="form-crud" onsubmit="saveCrudItem(event)">
                <input type="hidden" id="crud-id">
                <div id="crud-fields"></div>
                <div class="flex gap-2 mt-4"><button type="button" class="btn-outline w-full" onclick="closeModal('modal-crud')">Cancelar</button><button type="submit" class="btn-primary w-full">Salvar</button></div>
            </form>
        </div>
    </div>

    <!-- MODAL: IRRF -->
    <div id="modal-irrf" class="modal-overlay hidden" onclick="if(event.target===this) closeModal('modal-irrf')">
        <div class="modal">
            <h2>Faixa IRRF</h2>
            <form id="form-irrf" onsubmit="saveIrrfRow(event)">
                <input type="hidden" id="irrf-id">
                <label>At√© Base (R$)</label><input type="number" step="0.01" id="irrf-max" required>
                <label>%</label><input type="number" step="0.01" id="irrf-rate" required>
                <label>Dedu√ß√£o</label><input type="number" step="0.01" id="irrf-deduction" required>
                <div class="flex gap-2 mt-4"><button type="button" class="btn-outline w-full" onclick="closeModal('modal-irrf')">Cancelar</button><button type="submit" class="btn-primary w-full">Salvar</button></div>
            </form>
        </div>
    </div>

    <!-- MODAL: AGENDAMENTO -->
    <div id="modal-appointment" class="modal-overlay hidden" onclick="if(event.target===this) closeModal('modal-appointment')">
        <div class="modal">
            <h2>Agendamento</h2>
            <form id="form-appointment" onsubmit="saveAppointment(event)">
                <input type="hidden" id="appt-id">
                <label>T√≠tulo do Compromisso</label><input type="text" id="appt-title" required placeholder="Ex: Atendimento Jo√£o">
                <div class="flex gap-2">
                    <div class="w-full"><label>Data</label><input type="date" id="appt-date" required></div>
                    <div class="w-full"><label>Hora</label><input type="time" id="appt-time" required></div>
                </div>
                <div class="flex gap-2 items-end">
                    <div class="w-full">
                        <label>Buscar Cliente (Opcional)</label>
                        <select id="appt-client-select" onchange="fillAppointmentClient()"></select>
                    </div>
                </div>
                <div class="flex gap-2">
                    <div class="w-full"><label>Nome do Cliente</label><input type="text" id="appt-client-name" required></div>
                    <div class="w-full"><label>Telefone</label><input type="text" id="appt-client-phone"></div>
                </div>
                <label>Descri√ß√£o do Servi√ßo</label><textarea id="appt-desc" rows="2"></textarea>
                <div class="flex gap-2">
                    <div class="w-full"><label>Valor (R$)</label><input type="number" step="0.01" id="appt-value" placeholder="0.00"></div>
                    <div class="w-full"><label>Status</label><select id="appt-status"><option value="agendado">Agendado</option><option value="concluido">Conclu√≠do</option><option value="cancelado">Cancelado</option></select></div>
                </div>
                <div class="flex gap-2">
                    <div class="w-full"><label>Forma Pagto.</label><select id="appt-pay-method"><option value="pix">Pix</option><option value="dinheiro">Dinheiro</option><option value="cartao">Cart√£o</option></select></div>
                    <div class="w-full"><label>Status Pagto.</label><select id="appt-pay-status"><option value="pendente">Pendente</option><option value="pago">Pago</option></select></div>
                </div>
                <label>Observa√ß√µes</label><textarea id="appt-obs" rows="2"></textarea>
                <div class="flex gap-2 mt-4"><button type="button" class="btn-outline w-full" onclick="closeModal('modal-appointment')">Cancelar</button><button type="submit" class="btn-primary w-full">Salvar Agendamento</button></div>
            </form>
        </div>
    </div>

    <!-- MODAL: GEST√ÉO DE USU√ÅRIOS (ADMIN) -->
    <div id="modal-usermgmt" class="modal-overlay hidden" onclick="if(event.target===this) closeModal('modal-usermgmt')">
        <div class="modal" style="max-width: 800px;">
            <h2>Lista de Usu√°rios Cadastrados</h2>
            <div class="table-container mt-2" style="max-height: 400px; overflow-y: auto;">
                <table id="usermgmt-table">
                    <thead><tr><th>Nome</th><th>E-mail</th><th>Licen√ßa Expira em</th><th>A√ß√µes</th></tr></thead>
                    <tbody id="usermgmt-tbody"></tbody>
                </table>
            </div>
            <div class="mt-4 text-center">
                <button type="button" class="btn-outline" onclick="closeModal('modal-usermgmt')">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: CR√âDITOS (ADMIN) -->
    <div id="modal-credits" class="modal-overlay hidden" onclick="if(event.target===this) closeModal('modal-credits')">
        <div class="modal" style="max-width: 400px;">
            <h2>Gerenciar Cr√©ditos</h2>
            <p id="credit-user-display" class="mb-4 text-primary font-bold"></p>
            <input type="hidden" id="credit-user-id">
            
            <div class="mb-4">
                <label>Tipo de Ajuste:</label>
                <div class="flex gap-4">
                    <label style="font-weight:normal; display:flex; align-items:center; gap:5px;"><input type="radio" name="creditType" value="days" checked onchange="toggleCreditMode()"> Adicionar Dias</label>
                    <label style="font-weight:normal; display:flex; align-items:center; gap:5px;"><input type="radio" name="creditType" value="date" onchange="toggleCreditMode()"> Definir Data Limite</label>
                </div>
            </div>

            <div id="credit-mode-days">
                <label>Dias a adicionar:</label>
                <input type="number" id="credit-days-input" placeholder="Ex: 30, 90, 365">
            </div>

            <div id="credit-mode-date" class="hidden">
                <label>Nova Data de Validade:</label>
                <input type="date" id="credit-date-input">
            </div>

            <div class="flex gap-2 mt-4">
                <button type="button" class="btn-outline w-full" onclick="closeModal('modal-credits')">Cancelar</button>
                <button type="button" class="btn-success w-full" onclick="saveUserCredits()">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: ALERTA AUTOM√ÅTICO DE LEMBRETE -->
    <div id="modal-alert" class="modal-overlay hidden">
        <div class="modal" style="max-width: 400px; text-align: center; border-left: 5px solid var(--warning);">
            <h2 id="alert-title" class="mb-2">üîî Lembrete!</h2>
            <p id="alert-msg" class="mb-4 text-lg"></p>
            <p id="alert-time" class="text-sm text-light mb-4"></p>
            <div class="flex flex-col gap-2">
                <a id="alert-btn-email" href="#" class="btn-primary w-full">üìß Enviar Email Agora (Manual)</a>
                <button class="btn-outline w-full" onclick="closeModal('modal-alert')">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Script Principal - VERS√ÉO ATUALIZADA PARA 12.13 PARA LIMPAR CACHE DO GITHUB -->
    <script src="script.js?v=12.13"></script>
</body>
</html>

### 2. `script.js`
**Altera√ß√£o:** O c√≥digo permanece praticamente inalterado na l√≥gica (j√° estava usando `fetch`), mas garanti que n√£o houvesse resqu√≠cios do EmailJS. Adicionei um log `console.log("Payload enviado:", payload);` dentro da fun√ß√£o `sendAutoEmail` para que voc√™ possa verificar no console (F12) se os dados est√£o sendo montados corretamente antes de serem enviados para a Cloud Function.

```javascript
const DEFAULT_URL_FISCAL = "https://www.nfse.gov.br/EmissorNacional/Login?ReturnUrl=%2fEmissorNacional";
const DEFAULT_URL_DAS = "https://www8.receita.fazenda.gov.br/SimplesNacional/Aplicacoes/ATSPO/pgmei.app/Identificacao";
const DB_KEY = 'MEI_SYSTEM_V12_8'; 
const ADMIN_EMAILS = ['jcnvap@gmail.com', 'jcnval@gmail.com']; 

// --- CONFIGURA√á√ÉO DE EMAIL VIA CLOUD FUNCTION (BACKEND FIREBASE) ---
const CLOUD_FUNCTION_URL = "https://testemanualemail-cg2cq35buq-uc.a.run.app";

const LIC_PAD_VAL = 13;
const LIC_MULT_FACTOR = 9;
const LIC_YEAR_BASE = 1954;

// CONFIGURA√á√ÉO FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyBhtwWew_DQNX2TZROUShZz4mjK57pRgQk",
  authDomain: "lembrete-d6c15.firebaseapp.com",
  projectId: "lembrete-d6c15",
  storageBucket: "lembrete-d6c15.firebasestorage.app",
  messagingSenderId: "368296869868",
  appId: "1:368296869868:web:c6189a5ab9634029a90ac9",
  measurementId: "G-F5TMMGPK9C"
};

const DataManager = {
    dbName: 'MEI_DB_HYBRID_V2',
    storeName: 'mei_data',
    
    async initDB() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open(this.dbName, 1);
            req.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(this.storeName)) {
                    db.createObjectStore(this.storeName);
                }
            };
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    },

    async save(data) {
        // 1. Salva Localmente (Garantia Offline)
        try { localStorage.setItem(DB_KEY, JSON.stringify(data)); } catch(e) { console.warn("LocalStorage cheiou"); }

        try {
            const db = await this.initDB();
            const tx = db.transaction(this.storeName, 'readwrite');
            tx.objectStore(this.storeName).put(data, 'main_data');
        } catch(e) { console.error("Erro IDB Local", e); }

        // 2. Tenta Sincronizar com a Nuvem
        if (typeof firebase !== 'undefined' && firebase.apps.length && data.currentUser) {
            try {
                if (navigator.onLine) {
                    const db = firebase.firestore();
                    // Limpeza profunda do objeto para evitar erros do Firestore
                    const cleanData = JSON.parse(JSON.stringify(data));
                    await db.collection('users').doc(data.currentUser.id).set(cleanData);
                    this.updateSyncStatus(true);
                } else {
                    this.updateSyncStatus(false);
                }
            } catch(e) { 
                console.warn("Erro no Sync Cloud (Modo Offline Ativo):", e.code, e.message);
                this.updateSyncStatus(false);
            }
        } else {
            this.updateSyncStatus(false);
        }
    },

    async pullCloudData(userId) {
        if (typeof firebase !== 'undefined' && firebase.apps.length && navigator.onLine) {
            try {
                const db = firebase.firestore();
                const doc = await db.collection('users').doc(userId).get();
                if (doc.exists) {
                    console.log("Dados baixados da nuvem.");
                    return doc.data();
                }
            } catch (e) {
                console.error("Falha ao baixar dados Cloud:", e);
                if (e.code === 'permission-denied') {
                    alert("Erro de Permiss√£o no Firebase: Verifique as Regras do Firestore.");
                }
            }
        }
        return null;
    },

    async load() {
        let data = null;
        try {
            const db = await this.initDB();
            data = await new Promise(resolve => {
                const tx = db.transaction(this.storeName, 'readonly');
                const req = tx.objectStore(this.storeName).get('main_data');
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => resolve(null);
            });
        } catch(e) { console.warn("Erro carga IDB", e); }

        if (!data) {
            const ls = localStorage.getItem(DB_KEY);
            if (ls) data = JSON.parse(ls);
        }
        return data;
    },

    updateSyncStatus(isOnline) {
        const el = document.getElementById('sync-indicator');
        if(el) {
            el.className = `sync-status ${isOnline ? 'sync-online' : 'sync-offline'}`;
            el.title = isOnline ? 'Sincronizado (Nuvem)' : 'Modo Offline (Local)';
        }
    }
};

async function saveData() {
    await DataManager.save(appData);
}

if (typeof firebase !== 'undefined' && firebaseConfig.apiKey && firebaseConfig.apiKey !== "SUA_API_KEY_AQUI") {
    try { 
        firebase.initializeApp(firebaseConfig); 
        console.log("Firebase Inicializado");
        firebase.auth().onAuthStateChanged((user) => {
            if (user) console.log("Firebase Auth: OK");
        });
    } catch(e) { console.error("Erro Fatal Firebase Init", e); }
}

let appData = { currentUser: null, users: [], records: {}, irrfTable: [] };
let checkInterval = null; 

const DEFAULT_IRRF = [
    { id: 'irrf_1', max: 2259.20, rate: 0, deduction: 0 },
    { id: 'irrf_2', max: 2826.65, rate: 7.5, deduction: 169.44 },
    { id: 'irrf_3', max: 3751.05, rate: 15, deduction: 381.44 },
    { id: 'irrf_4', max: 4664.68, rate: 22.5, deduction: 662.77 },
    { id: 'irrf_5', max: 99999999, rate: 27.5, deduction: 896.00 }
];

let currentCrudType = 'products'; 
let currentListingType = 'clients';
let currentFinanceFilter = 'all';
let currentView = 'dashboard';

// --- FUN√á√ÉO AUXILIAR DE ENVIO AUTOM√ÅTICO (CLOUD FUNCTIONS) ---
async function sendAutoEmail(to_email, subject, message, attachment_data = null, attachment_name = null) {
    if (!navigator.onLine) {
        return Promise.reject("Sem conex√£o com a internet.");
    }

    try {
        const payload = {
            to: to_email,          
            email: to_email,       
            subject: subject,
            text: message,         
            html: message.replace(/\n/g, '<br>'), 
            attachment: attachment_data, 
            filename: attachment_name
        };

        // Debug para verificar o que est√° sendo enviado
        console.log("Payload enviado para Cloud Function:", payload);

        const response = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error(`Erro no servidor: ${response.status} ${response.statusText}`);
        }

        return true;

    } catch (error) {
        console.warn("Falha ao chamar Cloud Function:", error);
        throw error; 
    }
}

async function init() {
    try {
        const loadedData = await DataManager.load();
        if (loadedData) appData = loadedData;
        
        if (!appData.irrfTable || appData.irrfTable.length === 0) appData.irrfTable = JSON.parse(JSON.stringify(DEFAULT_IRRF));
        
        const sessionUser = sessionStorage.getItem('mei_user_id');
        
        setTimeout(() => {
            if (sessionUser) {
                const user = appData.users.find(u => u.id === sessionUser);
                if (user) { 
                    loginUser(user); 
                } else {
                    showAuth();
                }
            } else {
                showAuth();
            }
            const loader = document.getElementById('loading-overlay');
            if(loader) loader.style.display = 'none';
        }, 500);
    } catch(err) {
        console.error("Erro cr√≠tico na inicializa√ß√£o:", err);
        document.getElementById('loading-overlay').style.display = 'none';
        document.getElementById('auth-screen').classList.remove('hidden');
    }
}

function showAuth() { 
    document.getElementById('auth-screen').classList.remove('hidden'); 
    document.getElementById('app-container').classList.add('hidden'); 
}

async function loginUser(user) {
    const authScreen = document.getElementById('auth-screen');
    authScreen.classList.add('hidden');
    authScreen.style.display = 'none'; 

    document.getElementById('app-container').classList.remove('hidden');
    
    try {
        const cloudData = await DataManager.pullCloudData(user.id);
        if (cloudData) {
            appData = cloudData;
            const updatedUser = appData.users.find(u => u.id === user.id);
            if (updatedUser) user = updatedUser;
            DataManager.updateSyncStatus(true);
        }
    } catch(e) { console.log("Login Offline (Cloud falhou ou sem net)"); }

    appData.currentUser = user; 
    sessionStorage.setItem('mei_user_id', user.id);
    
    document.getElementById('user-name-display').innerText = user.name;
    
    if(!appData.records[user.id]) appData.records[user.id] = createSeedData();
    if(!appData.records[user.id].appointments) appData.records[user.id].appointments = [];
    if(!appData.records[user.id].reminders) appData.records[user.id].reminders = []; 
    
    checkLicense(); 
    navTo('dashboard'); 
    loadFiscalReminders();
    initReminderSystem(); 
    saveData(); 
}

async function manualSync() {
    if (!appData.currentUser) return;
    
    const btn = document.querySelector('.btn-sync');
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ Conectando...';
    btn.disabled = true;

    try {
        if (!navigator.onLine) throw new Error("Sem conex√£o com a internet.");
        
        if (!firebase.auth().currentUser) {
             throw new Error("Sess√£o Firebase expirada. Fa√ßa Logout e Login novamente com Google.");
        }

        const cloudData = await DataManager.pullCloudData(appData.currentUser.id);
        if (cloudData) {
            appData = cloudData;
            const updatedUser = appData.users.find(u => u.id === appData.currentUser.id);
            if(updatedUser) appData.currentUser = updatedUser;
        }

        await DataManager.save(appData);
        alert('Sincroniza√ß√£o OK! Dados salvos na nuvem.');
        navTo(currentView); 
    } catch (e) {
        console.error(e);
        if (e.code === 'unavailable') {
            alert("Firebase offline ou bloqueado pela rede.");
        } else if (e.code === 'permission-denied') {
            alert("Erro de Permiss√£o: Verifique as regras do Firestore e se o dom√≠nio est√° autorizado.");
        } else {
            alert('Erro: ' + e.message);
        }
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

function logout() { 
    if(checkInterval) clearInterval(checkInterval); 
    if (typeof firebase !== 'undefined') firebase.auth().signOut();
    appData.currentUser = null; 
    sessionStorage.removeItem('mei_user_id'); 
    location.reload(); 
}

function toggleAuth(screen) {
    document.getElementById('login-form').classList.toggle('hidden', screen === 'register');
    document.getElementById('register-form').classList.toggle('hidden', screen !== 'register');
}

function handleGoogleLogin() {
    console.log("Tentando login Google em: " + window.location.hostname);
    const provider = new firebase.auth.GoogleAuthProvider();
    firebase.auth().signInWithPopup(provider).then(async (result) => {
        const user = result.user;
        const cloudData = await DataManager.pullCloudData('u_' + user.uid);
        if (cloudData) appData = cloudData;

        let appUser = appData.users.find(u => u.email === user.email);
        if(!appUser) {
            appUser = {
                id: 'u_' + user.uid, 
                name: user.displayName, 
                email: user.email, 
                password: 'google_auth', 
                licenseExpire: new Date().getTime() + (30 * 86400000), // 30 dias
                company: { reserve_rate: 10, prolabore_target: 4000 }
            };
            appData.users.push(appUser);
            appData.records[appUser.id] = createSeedData();
        }
        loginUser(appUser);
    }).catch((error) => {
        console.error("Erro Google Auth:", error);
        if (error.code === 'auth/unauthorized-domain') {
            alert("ERRO CR√çTICO: DOM√çNIO N√ÉO AUTORIZADO NO FIREBASE.");
        } else if (error.code === 'auth/popup-closed-by-user') {
            alert("Login cancelado pelo usu√°rio.");
        } else {
            alert("Erro no Login: " + error.message);
        }
    });
}

function createSeedData() {
    const today = new Date().toISOString().split('T')[0];
    return { 
        products: [{id: 'p_ex', name: 'Produto Exemplo A', price: 100.00, description: 'Produto para teste'}], 
        services: [{id: 's_ex', name: 'Servi√ßo Exemplo B', price: 200.00, description: 'Servi√ßo para teste'}], 
        clients: [{id: 'c_ex', name: 'Cliente Teste', phone: '(11) 99999-9999', address: 'Rua Exemplo, 100', cnpj_cpf: '000.000.000-00', contact_person: 'Jo√£o', email: 'cliente@teste.com'}], 
        suppliers: [{id: 'f_ex', name: 'Fornecedor Teste', phone: '(11) 88888-8888', address: 'Av Exemplo, 200', cnpj_cpf: '00.000.000/0001-00', contact_person: 'Maria', email: 'fornecedor@teste.com'}], 
        transactions: [
            {id: 't_ex1', type: 'receita', category: 'Venda de produto', value: 150.00, date: today, obs: 'Venda inicial de teste', entity: 'Cliente Teste'},
            {id: 't_ex2', type: 'despesa', category: 'Despesas Operacionais', value: 50.00, date: today, obs: 'Despesa inicial de teste', entity: 'Fornecedor Teste'}
        ], 
        rpas: [],
        appointments: [],
        reminders: []
    };
}

// CORRE√á√ÉO: Cadastro agora √© async e for√ßa o salvamento na nuvem
document.getElementById('register-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('reg-email').value;
    if (appData.users.find(u => u.email === email)) return alert('E-mail j√° existe!');
    
    const newUser = {
        id: 'u_' + Date.now(), 
        name: document.getElementById('reg-name').value, 
        email: email,
        password: document.getElementById('reg-password').value,
        licenseExpire: new Date().getTime() + (30 * 86400000), // 30 dias
        company: { reserve_rate: 10, prolabore_target: 4000 }
    };

    // Atualiza estado local
    appData.users.push(newUser); 
    appData.records[newUser.id] = createSeedData();

    // CORRE√á√ÉO: Define o usu√°rio atual IMEDIATAMENTE para permitir o salvamento
    appData.currentUser = newUser;

    // Persist√™ncia Expl√≠cita no Firebase (Garantia de Cria√ß√£o)
    if (typeof firebase !== 'undefined' && navigator.onLine) {
        try {
            const db = firebase.firestore();
            // Salva os dados completos do usu√°rio rec√©m-criado
            // Clonamos para evitar erros de refer√™ncia circular se existirem (boas pr√°ticas)
            const userDataToSave = JSON.parse(JSON.stringify(appData));
            await db.collection('users').doc(newUser.id).set(userDataToSave);
            console.log("Novo usu√°rio salvo no Firebase com sucesso.");
        } catch (err) {
            console.error("Erro ao salvar novo usu√°rio na nuvem:", err);
            alert("Aten√ß√£o: Erro ao salvar na nuvem. Verifique sua conex√£o.");
        }
    }

    // Fluxo normal segue (saveData local + Login)
    saveData().then(() => loginUser(newUser));
});

document.getElementById('login-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const user = appData.users.find(u => u.email === document.getElementById('login-email').value && u.password === document.getElementById('login-password').value);
    user ? loginUser(user) : alert('Usu√°rio n√£o encontrado ou senha incorreta (Verifique se criou a conta neste dispositivo).');
});

function navTo(viewId) {
    currentView = viewId;
    document.querySelectorAll('main section').forEach(el => el.classList.add('hidden'));
    const target = document.getElementById('view-' + viewId);
    if(target) target.classList.remove('hidden');
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(el => {
        if(el.getAttribute('onclick') && el.getAttribute('onclick').includes(viewId)) {
            el.classList.add('active');
        }
    });
    
    if(viewId === 'dashboard') updateDashboard();
    if(viewId === 'listagens') switchListing('clients');
    if(viewId === 'financeiro') renderTransactions();
    if(viewId === 'cadastros') renderCrud(currentCrudType);
    if(viewId === 'agenda') renderAgenda(); 
    if(viewId === 'fiscal') {
        renderIrrf();
        const comp = appData.currentUser.company || {};
        document.getElementById('link-emissor').href = comp.url_fiscal || DEFAULT_URL_FISCAL;
        document.getElementById('link-das').href = comp.url_das || DEFAULT_URL_DAS;
    }
    if(viewId === 'configuracoes') {
        loadSettings();
        // FIX: Normaliza e-mail para min√∫sculas para evitar erro de Case Sensitivity no GitHub Pages
        const userEmail = appData.currentUser && appData.currentUser.email ? appData.currentUser.email.toLowerCase() : '';
        // Verifica se o email normalizado est√° na lista de admins
        if(ADMIN_EMAILS.includes(userEmail)) {
            document.getElementById('admin-panel').classList.remove('hidden');
        } else {
            document.getElementById('admin-panel').classList.add('hidden');
        }
    }
    if(viewId === 'lembretes') renderRemindersList();
    if(viewId === 'rpa') loadRPAOptions();
}

function loadSettings() {
    const c = appData.currentUser.company || {};
    document.getElementById('conf-company-name').value = c.name||''; 
    document.getElementById('conf-cnpj').value = c.cnpj||''; 
    document.getElementById('conf-address').value = c.address||''; 
    document.getElementById('conf-phone').value = c.phone||''; 
    document.getElementById('conf-whatsapp').value = c.whatsapp||'';
    document.getElementById('conf-auth-email').value = c.auth_email || ''; 
    document.getElementById('conf-url-fiscal').value = c.url_fiscal || DEFAULT_URL_FISCAL;
    document.getElementById('conf-url-das').value = c.url_das || DEFAULT_URL_DAS;
    document.getElementById('conf-reserve-rate').value = c.reserve_rate || 10;
    document.getElementById('conf-prolabore-target').value = c.prolabore_target || 4000;
}

function saveCompanyData(e) {
    e.preventDefault();
    try {
        const companyData = {
            name: document.getElementById('conf-company-name').value,
            cnpj: document.getElementById('conf-cnpj').value,
            address: document.getElementById('conf-address').value,
            phone: document.getElementById('conf-phone').value,
            whatsapp: document.getElementById('conf-whatsapp').value,
            role: document.getElementById('conf-role').value,
            auth_email: document.getElementById('conf-auth-email').value, 
            url_fiscal: document.getElementById('conf-url-fiscal').value,
            url_das: document.getElementById('conf-url-das').value,
            reserve_rate: parseFloat(document.getElementById('conf-reserve-rate').value),
            prolabore_target: parseFloat(document.getElementById('conf-prolabore-target').value)
        };
        appData.currentUser.company = companyData;
        
        const supplierId = 'sup_own_' + appData.currentUser.id;
        const supplierData = {
            id: supplierId, name: companyData.name + " (Minha Empresa)",
            cnpj_cpf: companyData.cnpj, phone: companyData.phone,
            address: companyData.address, email: appData.currentUser.email,
            contact_person: appData.currentUser.name, is_own_company: true
        };
        const userData = getUserData();
        if(userData) {
            const suppliersList = userData.suppliers;
            const supIndex = suppliersList.findIndex(s => s.id === supplierId);
            if(supIndex >= 0) suppliersList[supIndex] = supplierData; else suppliersList.push(supplierData);
            saveData(); 
            alert('Dados salvos!');
        }
    } catch(err) { alert('Erro ao salvar empresa: ' + err.message); }
}

function updateDashboard() {
    const userData = getUserData();
    if (!userData) return;
    const t = userData.transactions; 
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    const reserveRate = appData.currentUser.company.reserve_rate || 10;
    const prolaboreTarget = appData.currentUser.company.prolabore_target || 4000;

    let income = 0; let expense = 0; let totalReserve = 0; let totalProlabore = 0;
    t.forEach(x => {
        const d = new Date(x.date);
        if (x.type === 'receita') {
            if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                income += x.value;
                const reserveAmount = x.value * (reserveRate / 100);
                totalReserve += reserveAmount;
                const remainder = x.value - reserveAmount;
                const needed = prolaboreTarget - totalProlabore;
                if (needed > 0) totalProlabore += (remainder >= needed) ? needed : remainder;
            }
        } else {
            if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) expense += x.value;
        }
    });

    document.getElementById('dash-income').innerText = `R$ ${income.toFixed(2)}`;
    document.getElementById('dash-expense').innerText = `R$ ${expense.toFixed(2)}`;
    document.getElementById('dash-balance').innerText = `R$ ${(income-expense).toFixed(2)}`;
    document.getElementById('reserve-percent-display').innerText = reserveRate;
    document.getElementById('dash-reserve').innerText = `R$ ${totalReserve.toFixed(2)}`;
    document.getElementById('dash-prolabore').innerText = `R$ ${totalProlabore.toFixed(2)}`;
    document.getElementById('dash-prolabore-target').innerText = `Meta: R$ ${prolaboreTarget.toFixed(2)}`;
}

function renderAgenda(filter = '') {
    const userData = getUserData();
    if (!userData) return;
    if(!userData.appointments) userData.appointments = [];
    let list = userData.appointments.sort((a,b) => new Date(a.date+'T'+a.time) - new Date(b.date+'T'+b.time));

    if (filter === 'today') {
        const today = new Date().toISOString().split('T')[0];
        list = list.filter(a => a.date === today);
    } else if (!filter) {
        const inputDate = document.getElementById('agenda-filter-date').value;
        if(inputDate) list = list.filter(a => a.date === inputDate);
    }

    const container = document.getElementById('agenda-list');
    container.innerHTML = '';
    if (list.length === 0) { container.innerHTML = '<p class="text-center p-4" style="grid-column: 1/-1;">Nenhum agendamento encontrado.</p>'; return; }

    const statusMap = {
        'agendado': { label: 'Agendado', class: 'bg-scheduled', card: 'status-agendado' },
        'concluido': { label: 'Conclu√≠do', class: 'bg-done', card: 'status-concluido' },
        'cancelado': { label: 'Cancelado', class: 'bg-canceled', card: 'status-cancelado' }
    };

    list.forEach(a => {
        const st = statusMap[a.status] || statusMap['agendado'];
        const formattedDate = a.date.split('-').reverse().join('/');
        const card = document.createElement('div');
        card.className = `stat-card agenda-card ${st.card}`;
        card.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <span class="badge ${st.class}">${st.label}</span>
                <div class="text-sm font-bold text-light">${formattedDate} - ${a.time}</div>
            </div>
            <h3 class="mb-1">${a.title}</h3>
            <p class="text-sm mb-1"><strong>Cliente:</strong> ${a.client_name}</p>
            <p class="text-sm mb-2 text-light">${a.service_desc || 'Sem descri√ß√£o'}</p>
            <div class="flex justify-between items-center mt-2 border-t pt-2">
                <div class="text-sm">
                    <span class="${a.pay_status === 'pago' ? 'text-success font-bold' : 'text-warning'}">
                        ${a.pay_status === 'pago' ? 'üí≤ Pago' : '‚è≥ Pendente'}
                    </span>
                        - R$ ${parseFloat(a.value).toFixed(2)}
                </div>
                <div>
                    <button class="action-btn btn-warning" onclick="editAppointment('${a.id}')">‚úèÔ∏è</button>
                    <button class="action-btn btn-danger" onclick="deleteAppointment('${a.id}')">üóëÔ∏è</button>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

function openAppointmentModal(appt = null) {
    document.getElementById('form-appointment').reset();
    const clientSelect = document.getElementById('appt-client-select');
    clientSelect.innerHTML = '<option value="">Selecionar Cliente Cadastrado...</option>';
    getUserData().clients.forEach(c => { clientSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`; });

    if (appt) {
        document.getElementById('appt-id').value = appt.id;
        document.getElementById('appt-title').value = appt.title;
        document.getElementById('appt-date').value = appt.date;
        document.getElementById('appt-time').value = appt.time;
        document.getElementById('appt-client-name').value = appt.client_name;
        document.getElementById('appt-client-phone').value = appt.client_phone;
        document.getElementById('appt-desc').value = appt.service_desc;
        document.getElementById('appt-value').value = appt.value;
        document.getElementById('appt-status').value = appt.status;
        document.getElementById('appt-pay-method').value = appt.pay_method;
        document.getElementById('appt-pay-status').value = appt.pay_status;
        document.getElementById('appt-obs').value = appt.obs;
    } else {
        document.getElementById('appt-id').value = '';
        document.getElementById('appt-date').valueAsDate = new Date();
        document.getElementById('appt-status').value = 'agendado';
    }
    document.getElementById('modal-appointment').classList.remove('hidden');
}

function fillAppointmentClient() {
    const id = document.getElementById('appt-client-select').value;
    if(id) {
        const c = getUserData().clients.find(x => x.id === id);
        if(c) {
            document.getElementById('appt-client-name').value = c.name;
            document.getElementById('appt-client-phone').value = c.phone || '';
        }
    }
}

function saveAppointment(e) {
    e.preventDefault();
    try {
        const id = document.getElementById('appt-id').value;
        const data = {
            id: id || 'appt_' + Date.now(),
            title: document.getElementById('appt-title').value,
            date: document.getElementById('appt-date').value,
            time: document.getElementById('appt-time').value,
            client_name: document.getElementById('appt-client-name').value,
            client_phone: document.getElementById('appt-client-phone').value,
            service_desc: document.getElementById('appt-desc').value,
            value: document.getElementById('appt-value').value || 0,
            status: document.getElementById('appt-status').value,
            pay_method: document.getElementById('appt-pay-method').value,
            pay_status: document.getElementById('appt-pay-status').value,
            obs: document.getElementById('appt-obs').value
        };
        const list = getUserData().appointments;
        if (id) { const idx = list.findIndex(x => x.id === id); if(idx !== -1) list[idx] = data; } else { list.push(data); }
        saveData(); closeModal('modal-appointment'); renderAgenda();
    } catch(err) { alert('Erro ao salvar agendamento: ' + err.message); }
}

function editAppointment(id) { const appt = getUserData().appointments.find(a => a.id === id); if(appt) openAppointmentModal(appt); }
function deleteAppointment(id) { if(confirm('Excluir este agendamento?')) { const list = getUserData().appointments; const idx = list.findIndex(a => a.id === id); if(idx !== -1) list.splice(idx, 1); saveData(); renderAgenda(); } }

function loadRPAOptions() {
    const comp = appData.currentUser.company || {};
    document.getElementById('rpa-comp-name').value = comp.name || '';
    document.getElementById('rpa-comp-cnpj').value = comp.cnpj || '';
    document.getElementById('rpa-comp-addr').value = comp.address || '';
    // Usa nome e email do usu√°rio se n√£o houver um prestador selecionado
    if(!document.getElementById('rpa-prov-name').value) document.getElementById('rpa-prov-name').value = appData.currentUser.name;
    if(!document.getElementById('rpa-prov-email').value) document.getElementById('rpa-prov-email').value = comp.auth_email || '';

    const select = document.getElementById('rpa-provider-select');
    select.innerHTML = '<option value="">Selecione um Aut√¥nomo...</option>';
    getUserData().suppliers.forEach(s => select.innerHTML += `<option value="${s.id}">${s.name}</option>`);
    document.getElementById('rpa-date').valueAsDate = new Date();
    document.getElementById('rpa-id').value = '';
}

function fillRPAProvider() {
    const id = document.getElementById('rpa-provider-select').value;
    const s = getUserData().suppliers.find(item => item.id === id);
    if (s) {
        document.getElementById('rpa-prov-name').value = s.name;
        document.getElementById('rpa-prov-cpf').value = s.cnpj_cpf || '';
        document.getElementById('rpa-prov-phone').value = s.phone || '';
        document.getElementById('rpa-prov-addr').value = s.address || '';
        document.getElementById('rpa-prov-email').value = s.email || '';
    }
}

function calculateRPA() {
    const value = parseFloat(document.getElementById('rpa-value').value) || 0;
    const issRate = parseFloat(document.getElementById('rpa-iss-rate').value) || 0;
    const inss = value * 0.11;
    document.getElementById('rpa-inss').value = `R$ ${inss.toFixed(2)}`;
    const iss = value * (issRate / 100);
    document.getElementById('rpa-iss-val').value = `R$ ${iss.toFixed(2)}`;
    
    const irrfBase = value - inss;
    let irrf = 0;
    const table = appData.irrfTable.sort((a,b) => a.max - b.max);
    for(let row of table) {
        if (irrfBase <= row.max) { irrf = (irrfBase * (row.rate / 100)) - row.deduction; break; }
    }
    if (irrf < 0) irrf = 0;
    document.getElementById('rpa-irrf').value = `R$ ${irrf.toFixed(2)}`;
    document.getElementById('rpa-net').value = `R$ ${(value - inss - iss - irrf).toFixed(2)}`;
}

function saveRPA() {
    try {
        const id = document.getElementById('rpa-id').value;
        const rpa = {
            id: id || 'rpa_' + Date.now(),
            date: document.getElementById('rpa-date').value,
            provider: document.getElementById('rpa-prov-name').value,
            desc: document.getElementById('rpa-desc').value,
            value: document.getElementById('rpa-value').value,
            net: document.getElementById('rpa-net').value,
            fullData: {
                provName: document.getElementById('rpa-prov-name').value, provCpf: document.getElementById('rpa-prov-cpf').value,
                provPhone: document.getElementById('rpa-prov-phone').value, provAddr: document.getElementById('rpa-prov-addr').value,
                provEmail: document.getElementById('rpa-prov-email').value,
                inss: document.getElementById('rpa-inss').value, iss: document.getElementById('rpa-iss-val').value, irrf: document.getElementById('rpa-irrf').value
            }
        };
        const list = getUserData().rpas || (getUserData().rpas = []);
        if(id) { const idx = list.findIndex(r => r.id === id); if(idx !== -1) list[idx] = rpa; else list.push(rpa); } else { list.push(rpa); }
        saveData(); alert('RPA Salvo!'); toggleRPAHistory();
    } catch(err) { alert('Erro ao salvar RPA: ' + err.message); }
}

function sendRPAEmail() {
    const email = document.getElementById('rpa-prov-email').value;
    if(!email) return alert('Por favor, preencha o e-mail do aut√¥nomo.');
    
    const compName = document.getElementById('rpa-comp-name').value || "Empresa";
    const desc = document.getElementById('rpa-desc').value;
    const val = document.getElementById('rpa-net').value;
    const date = document.getElementById('rpa-date').value.split('-').reverse().join('/');
    const subject = `Recibo RPA - ${compName}`;
    const body = `Ol√°,\n\nSegue em anexo o RPA emitido.\n\nServi√ßo: ${desc}\nData: ${date}\nValor L√≠quido: ${val}\n\nAtt,\n${compName}`;

    // --- GERA√á√ÉO DO ANEXO ---
    const htmlContent = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'><head><meta charset='utf-8'><title>RPA</title></head><body><h2 style="text-align:center">RPA - ${compName}</h2><br><h3>1. Contratante</h3><p>Raz√£o: ${compName}</p><p>CNPJ: ${document.getElementById('rpa-comp-cnpj').value}</p><hr><h3>2. Aut√¥nomo</h3><p>Nome: ${document.getElementById('rpa-prov-name').value}</p><p>CPF: ${document.getElementById('rpa-prov-cpf').value}</p><hr><h3>3. Servi√ßo</h3><p>${document.getElementById('rpa-desc').value}</p><p>Data: ${document.getElementById('rpa-date').value}</p><hr><h3>4. Valores</h3><p>Bruto: R$ ${document.getElementById('rpa-value').value}</p><p>L√≠quido: ${document.getElementById('rpa-net').value}</p></body></html>`;
    
    const base64Attachment = btoa(unescape(encodeURIComponent(htmlContent)));
    const fileName = `RPA_${compName.replace(/[^a-zA-Z0-9]/g, '_')}.doc`;

    sendAutoEmail(email, subject, body, base64Attachment, fileName)
        .then(() => console.log("E-mail do RPA enviado automaticamente com sucesso (Anexo inclu√≠do)!"))
        .catch((err) => {
            console.warn("Falha no envio autom√°tico, abrindo cliente de email.", err);
            window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        });
}

function toggleRPAHistory() {
    const container = document.getElementById('rpa-history-container');
    container.classList.toggle('hidden');
    if(!container.classList.contains('hidden')) {
        const tbody = document.querySelector('#rpa-history-table tbody');
        tbody.innerHTML = '';
        const list = getUserData().rpas || [];
        list.sort((a,b) => new Date(b.date) - new Date(a.date));
        list.forEach(r => {
            tbody.innerHTML += `<tr><td>${r.date}</td><td>${r.provider}</td><td>${r.net}</td><td><button class="action-btn btn-warning" onclick="loadRPA('${r.id}')">‚úèÔ∏è</button><button class="action-btn btn-danger" onclick="deleteRPA('${r.id}')">üóëÔ∏è</button></td></tr>`;
        });
    }
}

function loadRPA(id) {
    const r = getUserData().rpas.find(x => x.id === id);
    if(r) {
        document.getElementById('rpa-id').value = r.id; document.getElementById('rpa-date').value = r.date;
        document.getElementById('rpa-desc').value = r.desc; document.getElementById('rpa-value').value = r.value;
        document.getElementById('rpa-prov-name').value = r.fullData.provName; document.getElementById('rpa-prov-cpf').value = r.fullData.provCpf;
        document.getElementById('rpa-prov-phone').value = r.fullData.provPhone; document.getElementById('rpa-prov-addr').value = r.fullData.provAddr;
        document.getElementById('rpa-prov-email').value = r.fullData.provEmail || '';
        calculateRPA(); alert('RPA Carregado.'); window.scrollTo(0,0);
    }
}

function deleteRPA(id) { if(confirm('Excluir este RPA?')) { const l = getUserData().rpas; l.splice(l.findIndex(r => r.id === id), 1); saveData(); toggleRPAHistory(); } }

function exportRPAPdf() { 
    const originalTitle = document.title;
    const compName = document.getElementById('rpa-comp-name').value || "Empresa";
    const cleanName = compName.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30);
    document.title = `RPA_${cleanName}`;
    document.querySelectorAll('section').forEach(s => s.classList.remove('active-print')); 
    document.getElementById('view-rpa').classList.add('active-print'); 
    window.print();
    setTimeout(() => { document.title = originalTitle; }, 1000);
}

function exportRPADoc() { 
    const compName = document.getElementById('rpa-comp-name').value || "Empresa";
    const cleanName = compName.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30);
    const html = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'><head><meta charset='utf-8'><title>RPA</title></head><body><h2 style="text-align:center">RPA - ${compName}</h2><br><h3>1. Contratante</h3><p>Raz√£o: ${compName}</p><p>CNPJ: ${document.getElementById('rpa-comp-cnpj').value}</p><hr><h3>2. Aut√¥nomo</h3><p>Nome: ${document.getElementById('rpa-prov-name').value}</p><p>CPF: ${document.getElementById('rpa-prov-cpf').value}</p><hr><h3>3. Servi√ßo</h3><p>${document.getElementById('rpa-desc').value}</p><p>Data: ${document.getElementById('rpa-date').value}</p><hr><h3>4. Valores</h3><p>Bruto: R$ ${document.getElementById('rpa-value').value}</p><p>L√≠quido: ${document.getElementById('rpa-net').value}</p></body></html>`; 
    const blob = new Blob([html], { type: 'application/msword' }); 
    const url = URL.createObjectURL(blob); 
    const a = document.createElement('a'); 
    a.href = url; 
    a.download = `RPA_${cleanName}.doc`; 
    a.click(); 
}

function exportReportPDF() { document.getElementById('report-company-header').innerText = appData.currentUser.company.name || "Minha Empresa"; document.querySelectorAll('section').forEach(s => s.classList.remove('active-print')); document.getElementById('view-listagens').classList.add('active-print'); window.print(); }
function exportReportDoc() { const header = `<h2>${appData.currentUser.company.name || "Minha Empresa"}</h2>`; const table = document.getElementById('listing-table').outerHTML; const html = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'><head><meta charset='utf-8'><title>Relat√≥rio</title></head><body>${header}<h3>Relat√≥rio do Sistema</h3>${table}</body></html>`; const blob = new Blob([html], { type: 'application/msword' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `Relatorio.doc`; a.click(); }

function renderCrud(type) { 
    currentCrudType = type; 
    document.getElementById('crud-title').innerText = type.toUpperCase(); 
    document.querySelectorAll('.crud-btn').forEach(btn => { btn.classList.toggle('active', btn.getAttribute('onclick').includes(`'${type}'`)); });
    const userData = getUserData();
    if (!userData) return;
    const list = userData[type]; 
    const table = document.getElementById('crud-table'); 
    let h = type.match(/products|services/) ? '<th>Nome</th><th>Desc</th><th>Pre√ßo</th>' : '<th>Nome</th><th>Contato</th><th>Info</th>'; 
    table.innerHTML = `<thead><tr>${h}<th>A√ß√µes</th></tr></thead><tbody>` + list.map(i => `<tr><td>${i.name}</td><td>${i.description || i.contact_person || '-'}</td><td>${i.price ? 'R$ '+i.price : i.phone}</td><td><button class="action-btn btn-warning" onclick="editCrudItem('${i.id}')">‚úèÔ∏è</button> <button class="action-btn btn-danger" onclick="deleteCrudItem('${type}','${i.id}')">üóëÔ∏è</button></td></tr>`).join('') + `</tbody>`; 
}

function openCrudModal(isEdit = false, itemData = null) { document.getElementById('modal-crud').classList.remove('hidden'); document.getElementById('crud-id').value = itemData ? itemData.id : ''; const fields = document.getElementById('crud-fields'); if(currentCrudType.match(/products|services/)) { fields.innerHTML = `<label>Nome</label><input name="name" value="${itemData?.name||''}" required><label>Pre√ßo</label><input type="number" step="0.01" name="price" value="${itemData?.price||''}" required><label>Descri√ß√£o</label><textarea name="description" rows="3">${itemData?.description||''}</textarea>`; } else { fields.innerHTML = `<label>Nome/Raz√£o</label><input name="name" value="${itemData?.name||''}" required><label>Contato</label><input name="contact_person" value="${itemData?.contact_person||''}"><label>CPF/CNPJ</label><input name="cnpj_cpf" value="${itemData?.cnpj_cpf||''}"><label>Endere√ßo</label><input name="address" value="${itemData?.address||''}"><label>Telefone</label><input name="phone" value="${itemData?.phone||''}"><label>Email</label><input name="email" value="${itemData?.email||''}">`; } }
function editCrudItem(id) { const item = getUserData()[currentCrudType].find(i => i.id === id); if (item) openCrudModal(true, item); }

function saveCrudItem(e) {
    e.preventDefault();
    try {
        const id = document.getElementById('crud-id').value;
        const els = e.target.elements;
        
        const item = {
            id: id || 'i_'+Date.now(),
            name: els['name'] ? els['name'].value : '',
            price: els['price'] ? els['price'].value : undefined,
            description: els['description'] ? els['description'].value : undefined,
            contact_person: els['contact_person'] ? els['contact_person'].value : undefined,
            phone: els['phone'] ? els['phone'].value : undefined,
            address: els['address'] ? els['address'].value : undefined,
            cnpj_cpf: els['cnpj_cpf'] ? els['cnpj_cpf'].value : undefined,
            email: els['email'] ? els['email'].value : undefined
        };
        
        const userData = getUserData();
        if(!userData) throw new Error("Usu√°rio n√£o carregado");
        
        const list = userData[currentCrudType];
        const idx = list.findIndex(i => i.id === id);
        if(idx !== -1) list[idx] = item; else list.push(item);
        
        saveData();
        closeModal('modal-crud');
        renderCrud(currentCrudType);
    } catch(err) {
        alert("Erro ao salvar item: " + err.message);
    }
}

function deleteCrudItem(t,id){ if(confirm('Apagar?')){const l=getUserData()[t]; l.splice(l.findIndex(x=>x.id===id),1); saveData(); renderCrud(t);} }
function getUserData() { 
    if (!appData.currentUser) return null;
    return appData.records[appData.currentUser.id]; 
}
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
function checkLicense() { const d = Math.ceil((appData.currentUser.licenseExpire - Date.now())/86400000); document.getElementById('license-days-display').innerText = d>0?d+' dias':'Expirado'; document.getElementById('license-warning').classList.toggle('hidden', d>0); }

function filterFinance(filter) {
    currentFinanceFilter = filter;
    document.querySelectorAll('.fin-filter-btn').forEach(btn => { btn.classList.toggle('active', btn.getAttribute('onclick').includes(`'${filter}'`)); });
    renderTransactions();
}

function renderTransactions(){ 
    const userData = getUserData();
    if (!userData) return;
    let l = userData.transactions.sort((a,b)=>new Date(b.date)-new Date(a.date)); 
    if (currentFinanceFilter !== 'all') { l = l.filter(t => t.type === currentFinanceFilter); }
    document.querySelector('#finance-table tbody').innerHTML = l.length > 0 ? 
        l.map(t=>`<tr><td>${t.date}</td><td>${t.type}</td><td>${t.category}</td><td>${t.obs||'-'}</td><td>R$ ${t.value}</td><td><button onclick="editTransaction('${t.id}')">‚úèÔ∏è</button><button onclick="deleteTransaction('${t.id}')">üóëÔ∏è</button></td></tr>`).join('') :
        '<tr><td colspan="6" class="text-center p-4">Nenhuma movimenta√ß√£o encontrada.</td></tr>';
}

function editTransaction(id){ 
    const t=getUserData().transactions.find(x=>x.id===id); 
    document.getElementById('trans-id').value=t.id; 
    document.getElementById('trans-type').value=t.type; 
    updateTransactionDependencies(); 
    document.getElementById('trans-category').value=t.category; 
    document.getElementById('trans-entity').value=t.entity;
    document.getElementById('trans-value').value=t.value; 
    document.getElementById('trans-date').value=t.date; 
    document.getElementById('trans-obs').value=t.obs; 
    document.getElementById('modal-transaction').classList.remove('hidden'); 
}

function saveTransaction(e){ 
    e.preventDefault(); 
    try {
        const id=document.getElementById('trans-id').value; 
        const t={
            id:id||'t_'+Date.now(), 
            type:document.getElementById('trans-type').value, 
            category:document.getElementById('trans-category').value, 
            value:parseFloat(document.getElementById('trans-value').value), 
            date:document.getElementById('trans-date').value, 
            obs:document.getElementById('trans-obs').value, 
            entity:document.getElementById('trans-entity').value
        }; 
        const userData = getUserData();
        const l=userData.transactions; 
        const i=l.findIndex(x=>x.id===t.id); 
        i!==-1?l[i]=t:l.push(t); 
        saveData(); closeModal('modal-transaction'); renderTransactions(); 
    } catch(err) { alert("Erro ao salvar transa√ß√£o: " + err.message); }
}

function deleteTransaction(id){ if(confirm('Apagar?')){const l=getUserData().transactions; l.splice(l.findIndex(x=>x.id===id),1); saveData(); renderTransactions();} }

function updateTransactionDependencies(){
    const type = document.getElementById('trans-type').value;
    const cats = type==='receita'?['Venda','Servi√ßo','Outros']:['Compra','Despesa','Imposto', 'Gastos Pessoais']; 
    document.getElementById('trans-category').innerHTML=cats.map(c=>`<option>${c}</option>`).join('');
    const select = document.getElementById('trans-entity');
    const userData = getUserData();
    if (!userData) return;
    const list = type === 'receita' ? userData.clients : userData.suppliers;
    if (list && list.length > 0) { select.innerHTML = '<option value="">Selecione...</option>' + list.map(i => `<option value="${i.name}">${i.name}</option>`).join(''); } 
    else { select.innerHTML = '<option value="">Sem cadastros dispon√≠veis</option>'; }
}

function openTransactionModal(){ document.getElementById('form-transaction').reset(); document.getElementById('trans-id').value=''; document.getElementById('modal-transaction').classList.remove('hidden'); updateTransactionDependencies(); }

function switchListing(t){ 
    currentListingType=t; 
    document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('active'); if(b.getAttribute('onclick').includes(`'${t}'`)) b.classList.add('active'); });
    document.getElementById('movements-filter').classList.toggle('hidden', t !== 'movimentacoes');
    renderListingTable();
}

function renderListingTable() {
    const t = currentListingType;
    const userData = getUserData();
    if (!userData) return;
    let data = t === 'movimentacoes' ? userData.transactions : userData[t];
    
    if (t === 'movimentacoes') {
        const monthFilter = document.getElementById('listing-month-filter').value; 
        if (monthFilter) {
            data = data.filter(i => i.date.startsWith(monthFilter));
        }
        data.sort((a,b) => new Date(b.date) - new Date(a.date));
    }

    document.getElementById('listing-thead').innerHTML = t === 'movimentacoes' 
        ? '<tr><th>Data</th><th>Tipo</th><th>Descri√ß√£o</th><th>Valor</th></tr>' 
        : '<tr><th>Nome</th><th>Detalhe</th><th>Valor/Tel</th></tr>'; 
    
    document.getElementById('listing-tbody').innerHTML = data.map(i => {
        if (t === 'movimentacoes') {
            const colorClass = i.type === 'receita' ? 'text-success' : 'text-danger';
            return `<tr><td>${i.date}</td><td>${i.type}</td><td>${i.obs || i.category}</td><td class="${colorClass}">${i.value}</td></tr>`;
        } else {
            return `<tr><td>${i.name}</td><td>${i.description||i.contact_person||'-'}</td><td>${i.price||i.phone||'-'}</td></tr>`;
        }
    }).join('');
}

function loadFiscalReminders(){ document.getElementById('fiscal-reminders').innerHTML='<li>DAS Dia 20</li>'; }
function downloadBackup(){ saveData(); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(appData)],{type:'json'})); a.download='backup.json'; a.click(); }
function restoreBackup(i){ const r=new FileReader(); r.onload=e=>{appData=JSON.parse(e.target.result);saveData();location.reload();}; r.readAsText(i.files[0]); }

function renderIrrf(){ document.getElementById('irrf-table-body').innerHTML=appData.irrfTable.map(r=>`<tr><td>${r.max}</td><td>${r.rate}</td><td>${r.deduction}</td><td><button class="action-btn btn-warning" onclick="editIrrfRow('${r.id}')">‚úèÔ∏è</button><button class="action-btn btn-danger" onclick="deleteIrrfRow('${r.id}')">X</button></td></tr>`).join(''); }
function deleteIrrfRow(id){ appData.irrfTable.splice(appData.irrfTable.findIndex(r=>r.id===id),1); saveData(); renderIrrf(); }
function openIrrfModal(){ document.getElementById('form-irrf').reset(); document.getElementById('irrf-id').value = ''; document.getElementById('modal-irrf').classList.remove('hidden'); }
function editIrrfRow(id) {
    const row = appData.irrfTable.find(r => r.id === id);
    if(row) {
        document.getElementById('irrf-id').value = row.id; document.getElementById('irrf-max').value = row.max;
        document.getElementById('irrf-rate').value = row.rate; document.getElementById('irrf-deduction').value = row.deduction;
        document.getElementById('modal-irrf').classList.remove('hidden');
    }
}
function saveIrrfRow(e){ 
    e.preventDefault(); 
    try {
        const id = document.getElementById('irrf-id').value;
        const data = { id: id || 'irrf_'+Date.now(), max:parseFloat(e.target[1].value), rate:parseFloat(e.target[2].value), deduction:parseFloat(e.target[3].value) };
        if (id) { const idx = appData.irrfTable.findIndex(r => r.id === id); if (idx !== -1) appData.irrfTable[idx] = data; } else { appData.irrfTable.push(data); }
        saveData(); closeModal('modal-irrf'); renderIrrf(); 
    } catch(err) { alert(err.message); }
}

// =========================================================================
// FUN√á√ïES RESTAURADAS & CORRE√á√ïES PARA GITHUB PAGES
// =========================================================================

function initReminderSystem() {
    if(checkInterval) clearInterval(checkInterval);
    checkInterval = setInterval(checkReminders, 60000); // Checa a cada minuto
}

function checkReminders() {
    if(!appData.currentUser) return;
    const reminders = getUserData().reminders || [];
    const now = new Date();
    
    reminders.forEach(r => {
        if (!r.nextRun) r.nextRun = r.datetime;
        const target = new Date(r.nextRun);
        
        if (now >= target) {
            // Atualizar UI do Modal (apenas para fallback ou modo manual)
            document.getElementById('alert-title').innerText = r.title;
            document.getElementById('alert-msg').innerText = r.msg;
            document.getElementById('alert-time').innerText = new Date(r.nextRun).toLocaleString();
            
            const mailto = `mailto:${r.email}?subject=${encodeURIComponent(r.title)}&body=${encodeURIComponent(r.msg)}`;
            document.getElementById('alert-btn-email').href = mailto;

            // L√ìGICA DE ENVIO AUTOM√ÅTICO vs MANUAL
            if(r.immediate) {
                // Modo Autom√°tico: Tenta enviar silenciosamente
                sendAutoEmail(r.email, r.title, r.msg)
                    .then(() => console.log(`Lembrete ${r.title} enviado via API (Silencioso)`))
                    .catch(e => {
                        console.error("Falha envio auto lembrete, exibindo modal manual:", e);
                        // Fallback: Abre o modal se o envio autom√°tico falhar
                        document.getElementById('modal-alert').classList.remove('hidden');
                    });
            } else {
                // Modo Manual: Exibe o modal sempre
                document.getElementById('modal-alert').classList.remove('hidden');
            }

            // Atualizar pr√≥xima execu√ß√£o
            const next = new Date(target);
            switch(r.period) {
                case 'hourly': next.setHours(next.getHours() + 1); break;
                case 'daily': next.setDate(next.getDate() + 1); break;
                case 'weekly': next.setDate(next.getDate() + 7); break;
                case 'biweekly': next.setDate(next.getDate() + 15); break;
                case 'monthly': next.setMonth(next.getMonth() + 1); break;
                case 'yearly': next.setFullYear(next.getFullYear() + 1); break;
                case 'once': 
                default:
                    reminders.splice(reminders.indexOf(r), 1);
                    saveData();
                    renderRemindersList();
                    return; 
            }
            r.nextRun = next.toISOString();
            saveData();
            renderRemindersList();
        }
    });
}

function renderRemindersList() {
    const list = getUserData().reminders || [];
    const tbody = document.getElementById('reminders-tbody');
    if(!tbody) return;
    tbody.innerHTML = list.length ? list.map(r => `
        <tr>
            <td>${r.title}</td>
            <td>${new Date(r.nextRun || r.datetime).toLocaleString()}</td>
            <td>${translatePeriod(r.period)}</td>
            <td>
                <button class="action-btn btn-danger" onclick="deleteReminder('${r.id}')">üóëÔ∏è</button>
            </td>
        </tr>
    `).join('') : '<tr><td colspan="4" class="text-center p-2">Nenhum lembrete configurado.</td></tr>';
}

function translatePeriod(p) {
    const map = { 'once': 'Uma vez', 'hourly': 'Por Hora', 'daily': 'Di√°rio', 'weekly': 'Semanal', 'biweekly': 'Quinzenal', 'monthly': 'Mensal', 'yearly': 'Anual' };
    return map[p] || p;
}

function saveReminder(e) {
    e.preventDefault();
    try {
        const id = document.getElementById('rem-id').value;
        const rem = {
            id: id || 'rem_' + Date.now(),
            title: document.getElementById('rem-title').value,
            datetime: document.getElementById('rem-datetime').value,
            period: document.getElementById('rem-period').value,
            email: document.getElementById('rem-email').value,
            msg: document.getElementById('rem-msg').value,
            immediate: document.getElementById('rem-immediate').checked,
            nextRun: document.getElementById('rem-datetime').value
        };

        const userData = getUserData();
        if(!userData.reminders) userData.reminders = [];
        
        if(id) {
            const idx = userData.reminders.findIndex(r => r.id === id);
            if(idx !== -1) userData.reminders[idx] = rem;
        } else {
            userData.reminders.push(rem);
        }

        // Se marcado "Enviar imediatamente" e for novo
        if (rem.immediate && !id) {
            sendAutoEmail(rem.email, rem.title, rem.msg)
                .then(() => console.log("E-mail imediato disparado com sucesso!")) // Alert removido para fluxo silencioso
                .catch(err => alert("Lembrete salvo, mas erro no envio autom√°tico: " + err));
        }

        saveData();
        document.querySelector('#view-lembretes form').reset();
        document.getElementById('rem-id').value = '';
        renderRemindersList();
        alert('Lembrete Salvo!');
    } catch(err) {
        alert('Erro ao salvar lembrete: ' + err.message);
    }
}

function cancelReminderEdit() {
    document.querySelector('#view-lembretes form').reset();
    document.getElementById('rem-id').value = '';
    document.getElementById('rem-btn-cancel').classList.add('hidden');
    document.getElementById('rem-form-title').innerText = 'üîî Novo Lembrete';
}

function deleteReminder(id) {
    if(confirm('Excluir este lembrete?')) {
        const userData = getUserData();
        userData.reminders = userData.reminders.filter(r => r.id !== id);
        saveData();
        renderRemindersList();
    }
}

// --- FUN√á√ïES DE ADMINISTRA√á√ÉO (Corrigidas para Robustez) ---

function openUserManagementModal() {
    console.log("Tentando abrir modal de gest√£o de usu√°rios..."); // Log para Debug no GitHub Pages

    if (!appData || !appData.users) {
        console.error("Erro: appData.users indefinido");
        alert("Erro ao carregar lista de usu√°rios. Tente sincronizar novamente.");
        return;
    }

    const tbody = document.getElementById('usermgmt-tbody');
    if (!tbody) {
        console.error("Erro HTML: Elemento usermgmt-tbody n√£o encontrado.");
        return;
    }

    tbody.innerHTML = '';
    
    appData.users.forEach(u => {
        // C√°lculo seguro de dias restantes
        let daysLeft = 0;
        if (u.licenseExpire) {
            daysLeft = Math.ceil((u.licenseExpire - Date.now()) / 86400000);
        }
        
        const statusClass = daysLeft > 0 ? 'text-success' : 'text-danger';
        const statusText = daysLeft > 0 ? daysLeft + ' dias' : 'Expirado';
        
        tbody.innerHTML += `
            <tr>
                <td>${u.name || 'Sem nome'}</td>
                <td>${u.email || '-'}</td>
                <td class="${statusClass}">${statusText}</td>
                <td>
                    <button class="action-btn btn-info" onclick="openCreditsModal('${u.id}')">üíé Cr√©ditos</button>
                    <button class="action-btn btn-danger" onclick="deleteUser('${u.id}')">üóëÔ∏è</button>
                </td>
            </tr>
        `;
    });
    
    const modal = document.getElementById('modal-usermgmt');
    if (modal) {
        modal.classList.remove('hidden');
        console.log("Modal aberto com sucesso.");
    } else {
        console.error("Erro HTML: Modal modal-usermgmt n√£o encontrado.");
    }
}

function openCreditsModal(userId) {
    const user = appData.users.find(u => u.id === userId);
    if (!user) return;
    
    document.getElementById('credit-user-id').value = userId;
    document.getElementById('credit-user-display').innerText = `Usu√°rio: ${user.name} (${user.email})`;
    document.getElementById('modal-credits').classList.remove('hidden');
}

function toggleCreditMode() {
    const mode = document.querySelector('input[name="creditType"]:checked').value;
    document.getElementById('credit-mode-days').classList.toggle('hidden', mode !== 'days');
    document.getElementById('credit-mode-date').classList.toggle('hidden', mode !== 'date');
}

function saveUserCredits() {
    const userId = document.getElementById('credit-user-id').value;
    const user = appData.users.find(u => u.id === userId);
    const mode = document.querySelector('input[name="creditType"]:checked').value;
    
    if (user) {
        if (mode === 'days') {
            const days = parseInt(document.getElementById('credit-days-input').value);
            if (!days) return alert("Digite a quantidade de dias.");
            
            // Se j√° expirou, conta a partir de hoje. Se n√£o, soma.
            const base = user.licenseExpire > Date.now() ? user.licenseExpire : Date.now();
            user.licenseExpire = base + (days * 86400000);
        } else {
            const dateStr = document.getElementById('credit-date-input').value;
            if (!dateStr) return alert("Selecione uma data.");
            user.licenseExpire = new Date(dateStr).getTime();
        }
        
        saveData();
        alert('Licen√ßa atualizada com sucesso!');
        closeModal('modal-credits');
        openUserManagementModal(); // Recarrega lista
    }
}

function deleteUser(userId) {
    if (userId === appData.currentUser.id) return alert("Voc√™ n√£o pode se excluir.");
    if (confirm("Tem certeza que deseja excluir este usu√°rio e todos os dados dele?")) {
        appData.users = appData.users.filter(u => u.id !== userId);
        delete appData.records[userId];
        saveData();
        openUserManagementModal();
    }
}

init();