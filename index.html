<!-- START OF FILE index.html -->

<!DOCTYPE html>
<!-- 
    GESTOR MEI - VERS√ÉO V11.5 (H√çBRIDO & SEGURO)
    
    ALTERA√á√ïES V11.5:
    1. Seguran√ßa: Substitui√ß√£o de valores fixos da licen√ßa por constantes declaradas.
    2. Arquitetura: Implementa√ß√£o de camada h√≠brida (Firebase + IndexedDB + LocalStorage).
    3. Compatibilidade: Suporte preparado para GitHub Pages e Deploy est√°tico.
    
    VERS√ïES ANTERIORES (V11.4 - AGENDA) MANTIDAS INTEGRALMENTE.
-->
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor MEI - Sistema H√≠brido V11.5</title>
    
    <!-- FIREBASE SDK (Compatibilidade H√≠brida) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --secondary: #1e40af;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #ca8a04;
            --info: #06b6d4;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --input-bg: #e0f2fe; 
            --input-border: #93c5fd;
            
            /* Status Colors for Agenda */
            --st-scheduled: #3b82f6;
            --st-done: #22c55e;
            --st-canceled: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background-color: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
        
        /* Utilit√°rios */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .p-4 { padding: 1rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.875rem; }
        .font-bold { font-weight: bold; }
        .text-danger { color: var(--danger); }
        .text-success { color: var(--success); }
        .text-primary { color: var(--primary); }
        .text-info { color: var(--info); }
        .text-warning { color: var(--warning); }

        /* Bot√µes e Inputs */
        label { display: block; margin-bottom: 0.25rem; font-weight: 600; font-size: 0.9rem; margin-top: 0.5rem; }
        
        input, select, textarea {
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid var(--input-border); 
            background-color: var(--input-bg); 
            border-radius: 0.375rem; 
            margin-bottom: 0.5rem; 
            outline: none;
            color: #0f172a;
            font-weight: 500;
        }
        input:focus, select:focus, textarea:focus { 
            border-color: var(--primary); 
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
            background-color: #dbeafe;
        }
        input[readonly] { background-color: #f3f4f6; border-color: #d1d5db; color: #4b5563; }

        button {
            padding: 0.75rem 1rem; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 600; transition: 0.2s;
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--secondary); }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-warning { background-color: var(--warning); color: white; }
        .btn-info { background-color: var(--info); color: white; }
        
        /* Bot√£o Outline e Estado Ativo */
        .btn-outline { background-color: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background-color: rgba(37, 99, 235, 0.1); }
        .btn-outline.active { background-color: var(--primary); color: white; }

        .google-btn { background-color: #db4437; color: white; }
        .action-btn { padding: 0.4rem 0.6rem; font-size: 0.85rem; margin-right: 0.25rem; margin-bottom: 0; }

        /* Auth Screen */
        #auth-screen {
            flex: 1; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        .auth-card {
            background: var(--card-bg); padding: 2rem; border-radius: 0.5rem; width: 100%; max-width: 400px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        /* Layout App */
        #app-container { display: flex; flex: 1; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        aside {
            width: 250px; background-color: #111827; color: white; display: flex; flex-direction: column; padding: 1rem; transition: transform 0.3s;
        }
        aside h2 { margin-bottom: 2rem; text-align: center; font-size: 1.5rem; }
        .nav-item {
            padding: 0.75rem; cursor: pointer; border-radius: 0.375rem; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.75rem;
        }
        .nav-item:hover, .nav-item.active { background-color: #374151; }
        .user-info { margin-top: auto; padding-top: 1rem; border-top: 1px solid #374151; font-size: 0.875rem; }

        /* Main Content */
        main { flex: 1; overflow-y: auto; padding: 1.5rem; }
        .view-header { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        
        /* Cards Dashboard */
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
        .stat-card { background: var(--card-bg); padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1rem; }
        .stat-value { font-size: 1.5rem; font-weight: bold; margin-top: 0.5rem; }
        .stat-sub { font-size: 0.9rem; color: var(--text-light); margin-top: 0.25rem; }

        /* Agenda / Compromissos Cards */
        .agenda-card {
            border-left: 5px solid var(--primary);
            position: relative;
        }
        .agenda-card.status-agendado { border-left-color: var(--st-scheduled); }
        .agenda-card.status-concluido { border-left-color: var(--st-done); }
        .agenda-card.status-cancelado { border-left-color: var(--st-canceled); opacity: 0.7; }

        .badge {
            padding: 0.2rem 0.5rem; border-radius: 1rem; font-size: 0.75rem; color: white; font-weight: bold; text-transform: uppercase;
        }
        .bg-scheduled { background-color: var(--st-scheduled); }
        .bg-done { background-color: var(--st-done); }
        .bg-canceled { background-color: var(--st-canceled); }
        .bg-gray { background-color: #6b7280; }

        /* Tabelas */
        .table-container { overflow-x: auto; background: var(--card-bg); border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { background-color: #f9fafb; font-weight: 600; }
        tr:hover { background-color: #f9fafb; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal { background: var(--card-bg); padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }

        /* Sync Status Indicator */
        .sync-status { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .sync-online { background-color: var(--success); box-shadow: 0 0 5px var(--success); }
        .sync-offline { background-color: var(--text-light); }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            #app-container { flex-direction: column; }
            aside { width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding: 0.5rem; }
            aside h2, .user-info { display: none; }
            .nav-item { flex: 0 0 auto; margin: 0; font-size: 0.8rem; }
            .dash-grid { grid-template-columns: 1fr; }
        }
        
        .notification-bar {
            background-color: var(--warning); color: white; padding: 0.5rem; text-align: center; font-weight: bold; font-size: 0.9rem;
        }

        /* Tabs para Listagens */
        .tabs { display: flex; gap: 0.5rem; overflow-x: auto; border-bottom: 2px solid var(--border); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .tab-btn { padding: 0.5rem 1rem; background: none; border: none; cursor: pointer; font-weight: 600; color: var(--text-light); border-radius: 0.25rem; white-space: nowrap; }
        .tab-btn.active { background-color: var(--primary); color: white; }

        /* RPA Estilo Espec√≠fico */
        .rpa-paper {
            background: white; border: 1px solid #ccc; padding: 2rem; max-width: 800px; margin: 0 auto;
        }
        .rpa-section { margin-bottom: 1rem; border: 1px solid #eee; padding: 1rem; border-radius: 4px; }
        .rpa-section h4 { margin-bottom: 0.5rem; border-bottom: 2px solid #eee; padding-bottom: 0.25rem; color: var(--primary); }
        
        /* Estilo de Impress√£o (PDF) */
        @media print {
            aside, .notification-bar, .view-header, .no-print, .tabs { display: none !important; }
            #app-container { height: auto; display: block; }
            main { padding: 0; overflow: visible; background: white; }
            body { background: white; }
            .table-container { box-shadow: none; border: none; }
            table { width: 100%; border: 1px solid #000; }
            th, td { border: 1px solid #000; padding: 5px; font-size: 12px; }
            #rpa-content { border: none; box-shadow: none; padding: 0; }
            .rpa-paper { border: none; padding: 0; width: 100%; max-width: none; }
            input, select { border: none; background: transparent; padding: 0; font-weight: bold; }
            section:not(.active-print) { display: none !important; }
        }
    </style>
</head>
<body>

    <!-- Tela de Autentica√ß√£o -->
    <div id="auth-screen">
        <div class="auth-card">
            <h2 class="text-center" style="margin-bottom: 1.5rem;">Gestor MEI</h2>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="E-mail" required>
                <input type="password" id="login-password" placeholder="Senha" required>
                <button type="submit" class="btn-primary w-full">Entrar</button>
                <div class="mt-4 flex flex-col gap-2">
                    <button type="button" class="btn-outline w-full" onclick="toggleAuth('register')">Criar Conta (90 dias gr√°tis)</button>
                    <!-- Google Auth Integration Hook -->
                    <button type="button" class="google-btn w-full" onclick="handleGoogleLogin()">Entrar com Google</button>
                    <a href="#" onclick="alert('Simula√ß√£o: Link de recupera√ß√£o enviado para o e-mail!')" class="text-center text-sm text-primary mt-2">Esqueci minha senha</a>
                </div>
            </form>
            <form id="register-form" class="hidden">
                <input type="text" id="reg-name" placeholder="Seu Nome Completo" required>
                <input type="email" id="reg-email" placeholder="E-mail" required>
                <input type="password" id="reg-password" placeholder="Senha" required>
                <button type="submit" class="btn-success w-full">Cadastrar e Ganhar 90 Dias</button>
                <button type="button" class="btn-outline w-full mt-4" onclick="toggleAuth('login')">Voltar para Login</button>
            </form>
        </div>
    </div>

    <!-- Aplica√ß√£o Principal -->
    <div id="app-container" class="hidden">
        <aside>
            <h2>Gestor MEI</h2>
            <nav class="flex-col flex w-full">
                <div class="nav-item active" onclick="navTo('dashboard')">üìä Dashboard</div>
                <div class="nav-item" onclick="navTo('agenda')">üìÖ Agenda</div>
                <div class="nav-item" onclick="navTo('cadastros')">üßæ Cadastros</div>
                <div class="nav-item" onclick="navTo('financeiro')">üí∞ Financeiro</div>
                <div class="nav-item" onclick="navTo('rpa')">üìÑ Gerador RPA</div>
                <div class="nav-item" onclick="navTo('fiscal')">üè¢ Fiscal & IRRF</div>
                <div class="nav-item" onclick="navTo('listagens')">üìë Listagens</div>
                <div class="nav-item" onclick="navTo('configuracoes')">‚öôÔ∏è Configura√ß√µes</div>
            </nav>
            <div class="user-info">
                <p>
                    <span id="sync-indicator" class="sync-status sync-offline" title="Offline / Local"></span>
                    <span id="user-name-display">Usu√°rio</span>
                </p>
                <p id="license-days-display" class="text-success text-sm">Licen√ßa Ativa</p>
                <button onclick="logout()" class="text-danger text-sm mt-2 w-full text-left" style="background: rgba(220, 38, 38, 0.1); border-radius: 4px; padding: 0.5rem; text-align: center;">üö™ Sair / Logout</button>
            </div>
        </aside>

        <main>
            <div id="license-warning" class="notification-bar hidden">Sua licen√ßa expirou! Renove nas configura√ß√µes.</div>

            <!-- View: Dashboard -->
            <section id="view-dashboard">
                <div class="view-header"><h1>Vis√£o Geral</h1></div>
                <div class="dash-grid">
                    <div class="stat-card"><h3>Receitas (M√™s)</h3><div class="stat-value text-success" id="dash-income">R$ 0,00</div></div>
                    <div class="stat-card"><h3>Despesas (M√™s)</h3><div class="stat-value text-danger" id="dash-expense">R$ 0,00</div></div>
                    <div class="stat-card"><h3>Saldo</h3><div class="stat-value" id="dash-balance">R$ 0,00</div></div>
                </div>
                <div class="dash-grid mt-4">
                    <div class="stat-card" style="border-left: 4px solid var(--info);">
                        <h3>Reserva (<span id="reserve-percent-display">10</span>%)</h3>
                        <div class="stat-value text-info" id="dash-reserve">R$ 0,00</div>
                        <div class="stat-sub">Acumulado das Entradas</div>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid var(--warning);">
                        <h3>Pr√≥-labore (M√™s)</h3>
                        <div class="stat-value text-warning" id="dash-prolabore">R$ 0,00</div>
                        <div class="stat-sub">Meta: <span id="dash-prolabore-target">R$ 0,00</span></div>
                    </div>
                </div>
                <div class="mt-4 flex gap-4 flex-col md:flex-row">
                    <div class="stat-card w-full"><h3>üìÖ Pr√≥ximos Compromissos Fiscais</h3><ul id="fiscal-reminders" class="mt-4" style="list-style: none;"></ul></div>
                    <div class="stat-card w-full"><h3>üìÇ Acesso R√°pido</h3><p class="mb-4">Relat√≥rios e Listagens.</p><button class="btn-info w-full" onclick="navTo('listagens')">Ver Listagens</button></div>
                </div>
            </section>

            <!-- View: Agenda (NOVO M√ìDULO) -->
            <section id="view-agenda" class="hidden">
                <div class="view-header flex justify-between items-center">
                    <h1>Agenda de Compromissos</h1>
                    <button class="btn-primary" onclick="openAppointmentModal()">+ Novo Agendamento</button>
                </div>
                <div class="flex gap-2 mb-4">
                    <input type="date" id="agenda-filter-date" onchange="renderAgenda()" style="max-width: 200px; margin:0;">
                    <button class="btn-outline" onclick="renderAgenda('all')">Ver Todos</button>
                    <button class="btn-outline" onclick="renderAgenda('today')">Hoje</button>
                </div>
                <div id="agenda-list" class="dash-grid">
                    <!-- Cards de compromissos inseridos via JS -->
                </div>
            </section>

            <!-- View: Listagens -->
            <section id="view-listagens" class="hidden">
                <div class="view-header flex justify-between items-center">
                    <h1>Relat√≥rios</h1>
                    <div class="no-print">
                        <button class="btn-primary" onclick="exportReportPDF()">üñ®Ô∏è PDF</button>
                        <button class="btn-info" onclick="exportReportDoc()">üìÑ Word</button>
                    </div>
                </div>
                <div class="tabs no-print">
                    <button class="tab-btn active" onclick="switchListing('clients')">Clientes</button>
                    <button class="tab-btn" onclick="switchListing('suppliers')">Fornecedores</button>
                    <button class="tab-btn" onclick="switchListing('products')">Produtos</button>
                    <button class="tab-btn" onclick="switchListing('services')">Servi√ßos</button>
                    <button class="tab-btn" onclick="switchListing('movimentacoes')">Movimenta√ß√µes</button>
                </div>
                <div id="movements-filter" class="stat-card mb-4 hidden no-print">
                    <label>Filtrar por M√™s e Ano:</label>
                    <div class="flex gap-2">
                        <input type="month" id="listing-month-filter" onchange="renderListingTable()">
                        <button class="btn-outline" style="width: auto;" onclick="renderListingTable()">Filtrar</button>
                    </div>
                </div>
                <div class="table-container" id="report-print-area">
                    <h3 id="report-company-header" class="text-center mb-4" style="text-transform: uppercase;"></h3>
                    <h3 id="report-title" class="hidden text-center">Relat√≥rio</h3>
                    <table id="listing-table"><thead id="listing-thead"></thead><tbody id="listing-tbody"></tbody></table>
                </div>
            </section>

            <!-- View: Financeiro -->
            <section id="view-financeiro" class="hidden">
                <div class="view-header flex justify-between items-center">
                    <h1>Movimenta√ß√µes Financeiras</h1>
                    <button class="btn-primary" onclick="openTransactionModal()">+ Novo Lan√ßamento</button>
                </div>
                <div class="flex gap-4 mb-4">
                    <button class="btn-outline fin-filter-btn active" onclick="filterFinance('all')">Todos</button>
                    <button class="btn-outline fin-filter-btn" onclick="filterFinance('receita')">Entradas</button>
                    <button class="btn-outline fin-filter-btn" onclick="filterFinance('despesa')">Sa√≠das</button>
                </div>
                <div class="table-container">
                    <table id="finance-table">
                        <thead><tr><th>Data</th><th>Tipo</th><th>Categoria</th><th>Descri√ß√£o</th><th>Valor</th><th>A√ß√µes</th></tr></thead><tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- View: Gerador RPA -->
            <section id="view-rpa" class="hidden">
                <div class="view-header no-print"><h1>Gerador de RPA</h1></div>
                
                <div class="stat-card mb-4 no-print">
                    <div class="flex gap-4 flex-col md:flex-row">
                        <div class="w-full">
                            <h3 class="mb-2">Automa√ß√£o</h3>
                            <label>Selecione o Aut√¥nomo:</label>
                            <select id="rpa-provider-select" onchange="fillRPAProvider()"><option value="">Selecione...</option></select>
                        </div>
                        <div class="w-full">
                            <h3 class="mb-2">A√ß√µes</h3>
                            <div class="flex gap-2 mb-2">
                                <button class="btn-success w-full" onclick="saveRPA()">üíæ Salvar RPA</button>
                                <button class="btn-warning w-full" onclick="toggleRPAHistory()">üìú Hist√≥rico</button>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn-primary w-full" onclick="exportRPAPdf()">üñ®Ô∏è PDF</button>
                                <button class="btn-info w-full" onclick="exportRPADoc()">üìÑ Word</button>
                            </div>
                        </div>
                    </div>
                    <div id="rpa-history-container" class="hidden mt-4 border-t pt-4">
                        <h4>Recibos Salvos</h4>
                        <div class="table-container">
                            <table id="rpa-history-table"><thead><tr><th>Data</th><th>Aut√¥nomo</th><th>Valor L√≠quido</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
                        </div>
                    </div>
                </div>

                <div class="rpa-paper" id="rpa-content">
                    <h2 class="text-center mb-4" style="text-decoration: underline;">RECIBO DE PAGAMENTO A AUT√îNOMO (RPA)</h2>
                    <input type="hidden" id="rpa-id">
                    <div class="rpa-section">
                        <h4>1. Contratante (Empresa)</h4>
                        <label>Raz√£o Social:</label><input type="text" id="rpa-comp-name">
                        <div class="flex gap-2"><div class="w-full"><label>CNPJ:</label><input type="text" id="rpa-comp-cnpj"></div><div class="w-full"><label>Endere√ßo:</label><input type="text" id="rpa-comp-addr"></div></div>
                    </div>
                    <div class="rpa-section">
                        <h4>2. Aut√¥nomo (Prestador)</h4>
                        <label>Nome Completo:</label><input type="text" id="rpa-prov-name">
                        <div class="flex gap-2"><div class="w-full"><label>CPF:</label><input type="text" id="rpa-prov-cpf"></div><div class="w-full"><label>Telefone:</label><input type="text" id="rpa-prov-phone"></div></div>
                        <label>Endere√ßo:</label><input type="text" id="rpa-prov-addr">
                    </div>
                    <div class="rpa-section">
                        <h4>3. Servi√ßo Prestado</h4>
                        <label>Descri√ß√£o:</label><input type="text" id="rpa-desc" placeholder="Ex: Consultoria">
                        <label>Data:</label><input type="date" id="rpa-date">
                    </div>
                    <div class="rpa-section">
                        <h4>4. Valor do Servi√ßo</h4>
                        <label>Valor Bruto (R$):</label><input type="number" id="rpa-value" step="0.01" oninput="calculateRPA()" placeholder="0,00">
                    </div>
                    <div class="rpa-section">
                        <h4>5. C√°lculo dos Descontos</h4>
                        <div class="flex gap-2">
                            <div class="w-full"><label>a) INSS (11%):</label><input type="text" id="rpa-inss" readonly></div>
                            <div class="w-full"><label>b) ISS (%: <input type="number" id="rpa-iss-rate" value="3" style="width:50px;display:inline;" oninput="calculateRPA()">):</label><input type="text" id="rpa-iss-val" readonly></div>
                        </div>
                        <label>c) IRRF:</label><input type="text" id="rpa-irrf" readonly>
                        <hr class="mt-2 mb-2">
                        <label style="font-size: 1.2rem; color: var(--primary);">‚û° Valor L√≠quido:</label>
                        <input type="text" id="rpa-net" readonly style="font-size: 1.5rem; font-weight: bold;">
                    </div>
                    <div class="rpa-section" style="border:none;">
                        <h4>6. Declara√ß√£o</h4>
                        <p style="text-align: justify; font-size: 0.9rem;">Declaro que prestei os servi√ßos acima descritos e recebi da contratante o valor l√≠quido correspondente, dando o presente recibo como pago e quitado.</p>
                        <br><br>
                        <div class="flex gap-4">
                            <div class="w-full text-center"><p>______________________________________</p><p><strong>Prestador</strong></p><p>Data: ____ / ____ / ______</p></div>
                            <div class="w-full text-center"><p>______________________________________</p><p><strong>Contratante</strong></p><p>Data: ____ / ____ / ______</p></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- View: Cadastros -->
            <section id="view-cadastros" class="hidden">
                <div class="view-header"><h1>Cadastros</h1></div>
                <div class="flex gap-2 mb-4 overflow-x-auto">
                    <button class="btn-outline crud-btn" onclick="renderCrud('products')">Produtos</button>
                    <button class="btn-outline crud-btn" onclick="renderCrud('services')">Servi√ßos</button>
                    <button class="btn-outline crud-btn" onclick="renderCrud('clients')">Clientes</button>
                    <button class="btn-outline crud-btn" onclick="renderCrud('suppliers')">Fornecedores</button>
                </div>
                <div id="crud-area" class="stat-card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="crud-title">Itens</h3>
                        <button class="btn-primary" onclick="openCrudModal(false)">+ Adicionar</button>
                    </div>
                    <div class="table-container"><table id="crud-table"></table></div>
                </div>
            </section>

            <!-- View: Fiscal -->
            <section id="view-fiscal" class="hidden">
                <div class="view-header"><h1>Fiscal & Obriga√ß√µes</h1></div>
                <div class="dash-grid">
                    <div class="stat-card text-center">
                        <h3>Emitir Nota Fiscal</h3>
                        <p class="text-sm text-light mb-4">Link Configurado</p>
                        <a id="link-emissor" href="#" target="_blank" class="btn-primary">Acessar Emissor</a>
                    </div>
                    <div class="stat-card">
                        <h3>DAS MEI</h3>
                        <p class="mb-2">Vencimento dia 20.</p>
                        <a id="link-das" href="#" target="_blank" class="btn-outline w-full text-center">Gerar Boleto DAS</a>
                    </div>
                </div>
                <div class="stat-card mt-4">
                    <div class="flex justify-between items-center mb-2"><h3>Tabela IRRF</h3><button class="btn-info action-btn" onclick="openIrrfModal()">+ Faixa</button></div>
                    <div class="table-container mt-2"><table id="irrf-table-display"><thead><tr><th>At√© Base (R$)</th><th>%</th><th>Dedu√ß√£o</th><th>X</th></tr></thead><tbody id="irrf-table-body"></tbody></table></div>
                </div>
            </section>

            <!-- View: Configura√ß√µes -->
            <section id="view-configuracoes" class="hidden">
                <div class="view-header"><h1>Configura√ß√µes</h1></div>
                <div class="stat-card mb-4">
                    <h3>üè¢ Dados da Empresa & URLs</h3>
                    <form onsubmit="saveCompanyData(event)">
                        <label>Nome Fantasia</label><input type="text" id="conf-company-name" required>
                        <div class="flex gap-2">
                            <div class="w-full"><label>CNPJ</label><input type="text" id="conf-cnpj"></div>
                            <div class="w-full"><label>Telefone</label><input type="text" id="conf-phone"></div>
                        </div>
                        <label>Endere√ßo Completo</label><input type="text" id="conf-address">
                        <label>WhatsApp</label><input type="text" id="conf-whatsapp">
                        <label>Atua√ß√£o</label>
                        <select id="conf-role">
                            <option value="both">Vendedor e Prestador</option>
                            <option value="seller">Vendedor</option>
                            <option value="provider">Prestador</option>
                        </select>
                        <hr class="mt-4 mb-4">
                        <h4>Par√¢metros Financeiros</h4>
                        <div class="flex gap-2">
                            <div class="w-full"><label>Percentual Reserva (%)</label><input type="number" id="conf-reserve-rate" step="0.1" placeholder="Sugest√£o: 10"></div>
                            <div class="w-full"><label>Meta Pr√≥-labore (R$)</label><input type="number" id="conf-prolabore-target" step="0.01" placeholder="Padr√£o: 4000.00"></div>
                        </div>
                        <hr class="mt-4 mb-4">
                        <h4>Links Externos</h4>
                        <label>URL Emissor Fiscal</label><input type="url" id="conf-url-fiscal" placeholder="Padr√£o do Governo...">
                        <label>URL Gera√ß√£o DAS</label><input type="url" id="conf-url-das" placeholder="Padr√£o do Governo...">
                        <button type="submit" class="btn-primary mt-2">Salvar Dados</button>
                    </form>
                </div>
                <div class="stat-card mb-4">
                    <h3>üíæ Backup & Sincroniza√ß√£o</h3>
                    <div class="flex gap-4 mt-2 items-center flex-wrap">
                        <button class="btn-info" onclick="downloadBackup()">üì• Backup (.json)</button>
                        <div class="flex flex-col"><label style="margin-top:0">Restaurar</label><input type="file" id="restore-file" accept=".json" onchange="restoreBackup(this)"></div>
                    </div>
                </div>
                <div class="stat-card mb-4">
                    <h3>üîê Licen√ßa</h3>
                    <div class="flex flex-col gap-2 mt-2">
                        <!-- Mantido o mascaramento visual -->
                        <div class="flex gap-2"><input type="password" id="license-random-code" readonly><button class="btn-outline" onclick="generateLicenseCode()">Gerar</button></div>
                        <input type="number" id="license-days-input" placeholder="Dias">
                        <button class="btn-success" onclick="sendWhatsApp()">üì± WhatsApp</button>
                        <div class="flex gap-2"><input type="number" id="license-key-input" placeholder="Contra-senha"><button class="btn-primary" onclick="validateLicense()">Validar</button></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modais -->
    <div id="modal-transaction" class="modal-overlay hidden">
        <div class="modal">
            <h2>Lan√ßamento Financeiro</h2>
            <form id="form-transaction" onsubmit="saveTransaction(event)">
                <input type="hidden" id="trans-id">
                <label>Tipo</label><select id="trans-type" onchange="updateTransactionDependencies()" required><option value="receita">Entrada</option><option value="despesa">Sa√≠da</option></select>
                <label>Categoria</label><select id="trans-category" required></select>
                <label>Valor</label><input type="number" id="trans-value" step="0.01" required>
                <label>Data</label><input type="date" id="trans-date" required>
                <label>Cliente/Fornecedor</label><select id="trans-entity"><option value="">Selecione...</option></select>
                <label>Descri√ß√£o</label><textarea id="trans-obs" rows="3"></textarea>
                <div class="flex gap-2 mt-4"><button type="button" class="btn-outline w-full" onclick="closeModal('modal-transaction')">Cancelar</button><button type="submit" class="btn-primary w-full">Salvar</button></div>
            </form>
        </div>
    </div>

    <div id="modal-crud" class="modal-overlay hidden">
        <div class="modal">
            <h2 id="modal-crud-title">Item</h2>
            <form id="form-crud" onsubmit="saveCrudItem(event)">
                <input type="hidden" id="crud-id">
                <div id="crud-fields"></div>
                <div class="flex gap-2 mt-4"><button type="button" class="btn-outline w-full" onclick="closeModal('modal-crud')">Cancelar</button><button type="submit" class="btn-primary w-full">Salvar</button></div>
            </form>
        </div>
    </div>

    <div id="modal-irrf" class="modal-overlay hidden">
        <div class="modal">
            <h2>Faixa IRRF</h2>
            <form id="form-irrf" onsubmit="saveIrrfRow(event)">
                <input type="hidden" id="irrf-id">
                <label>At√© Base (R$)</label><input type="number" step="0.01" id="irrf-max" required>
                <label>%</label><input type="number" step="0.01" id="irrf-rate" required>
                <label>Dedu√ß√£o</label><input type="number" step="0.01" id="irrf-deduction" required>
                <div class="flex gap-2 mt-4"><button type="button" class="btn-outline w-full" onclick="closeModal('modal-irrf')">Cancelar</button><button type="submit" class="btn-primary w-full">Salvar</button></div>
            </form>
        </div>
    </div>

    <!-- Modal Agenda (NOVO) -->
    <div id="modal-appointment" class="modal-overlay hidden">
        <div class="modal">
            <h2>Agendamento</h2>
            <form id="form-appointment" onsubmit="saveAppointment(event)">
                <input type="hidden" id="appt-id">
                
                <label>T√≠tulo do Compromisso</label>
                <input type="text" id="appt-title" required placeholder="Ex: Atendimento Jo√£o">

                <div class="flex gap-2">
                    <div class="w-full"><label>Data</label><input type="date" id="appt-date" required></div>
                    <div class="w-full"><label>Hora</label><input type="time" id="appt-time" required></div>
                </div>

                <div class="flex gap-2 items-end">
                    <div class="w-full">
                        <label>Buscar Cliente (Opcional)</label>
                        <select id="appt-client-select" onchange="fillAppointmentClient()"></select>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <div class="w-full"><label>Nome do Cliente</label><input type="text" id="appt-client-name" required></div>
                    <div class="w-full"><label>Telefone</label><input type="text" id="appt-client-phone"></div>
                </div>

                <label>Descri√ß√£o do Servi√ßo</label>
                <textarea id="appt-desc" rows="2"></textarea>

                <div class="flex gap-2">
                    <div class="w-full"><label>Valor (R$)</label><input type="number" step="0.01" id="appt-value" placeholder="0.00"></div>
                    <div class="w-full">
                        <label>Status</label>
                        <select id="appt-status">
                            <option value="agendado">Agendado</option>
                            <option value="concluido">Conclu√≠do</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-2">
                    <div class="w-full">
                        <label>Forma Pagto.</label>
                        <select id="appt-pay-method">
                            <option value="pix">Pix</option>
                            <option value="dinheiro">Dinheiro</option>
                            <option value="cartao">Cart√£o</option>
                        </select>
                    </div>
                    <div class="w-full">
                        <label>Status Pagto.</label>
                        <select id="appt-pay-status">
                            <option value="pendente">Pendente</option>
                            <option value="pago">Pago</option>
                        </select>
                    </div>
                </div>

                <label>Observa√ß√µes</label>
                <textarea id="appt-obs" rows="2"></textarea>

                <div class="flex gap-2 mt-4">
                    <button type="button" class="btn-outline w-full" onclick="closeModal('modal-appointment')">Cancelar</button>
                    <button type="submit" class="btn-primary w-full">Salvar Agendamento</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- CONSTANTES DE SEGURAN√áA E CONFIGURA√á√ÉO ---
        const DEFAULT_URL_FISCAL = "https://www.nfse.gov.br/EmissorNacional/Login?ReturnUrl=%2fEmissorNacional";
        const DEFAULT_URL_DAS = "https://www8.receita.fazenda.gov.br/SimplesNacional/Aplicacoes/ATSPO/pgmei.app/Identificacao";
        const DB_KEY = 'MEI_SYSTEM_V11';
        
        // NOVO: Constantes da Licen√ßa (Seguran√ßa aprimorada V11.5)
        const LIC_PAD_VAL = 13;
        const LIC_MULT_FACTOR = 9;
        const LIC_YEAR_BASE = 1954;

        // NOVO: Configura√ß√£o Firebase (Preencha com suas chaves para ativar Cloud)
const firebaseConfig = {
  apiKey: "AIzaSyAY06PHLqEUCBzg9SjnH4N6xe9ZzM8OLvo",
  authDomain: "projeto-bfed3.firebaseapp.com",
  projectId: "projeto-bfed3",
  storageBucket: "projeto-bfed3.firebasestorage.app",
  messagingSenderId: "785289237066",
  appId: "1:785289237066:web:8206fe2e1073db72d5ccb3"
};


        // --- GESTOR DE DADOS H√çBRIDO (IndexedDB + Firebase + LocalStorage) ---
        const DataManager = {
            dbName: 'MEI_DB_HYBRID',
            storeName: 'mei_data',
            
            async initDB() {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(this.dbName, 1);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName);
                        }
                    };
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            },

            async save(data) {
                // 1. LocalStorage (Backup s√≠ncrono legado)
                try { localStorage.setItem(DB_KEY, JSON.stringify(data)); } catch(e) { console.warn("LocalStorage full"); }

                // 2. IndexedDB (Armazenamento robusto offline)
                try {
                    const db = await this.initDB();
                    const tx = db.transaction(this.storeName, 'readwrite');
                    tx.objectStore(this.storeName).put(data, 'main_data');
                } catch(e) { console.error("IDB Error", e); }

                // 3. Firebase (Se configurado e online)
                if (firebase.apps.length && data.currentUser) {
                    try {
                        const db = firebase.firestore();
                        await db.collection('users').doc(data.currentUser.id).set(data);
                        this.updateSyncStatus(true);
                    } catch(e) { 
                        console.error("Cloud Sync Error", e); 
                        this.updateSyncStatus(false);
                    }
                } else {
                    this.updateSyncStatus(false);
                }
            },

            async load() {
                let data = null;

                // Tenta carregar do IndexedDB primeiro (mais confi√°vel para dados grandes)
                try {
                    const db = await this.initDB();
                    data = await new Promise(resolve => {
                        const tx = db.transaction(this.storeName, 'readonly');
                        const req = tx.objectStore(this.storeName).get('main_data');
                        req.onsuccess = () => resolve(req.result);
                        req.onerror = () => resolve(null);
                    });
                } catch(e) { console.warn("IDB Load Fail", e); }

                // Fallback para LocalStorage
                if (!data) {
                    const ls = localStorage.getItem(DB_KEY);
                    if (ls) data = JSON.parse(ls);
                }

                return data;
            },

            updateSyncStatus(isOnline) {
                const el = document.getElementById('sync-indicator');
                if(el) {
                    el.className = `sync-status ${isOnline ? 'sync-online' : 'sync-offline'}`;
                    el.title = isOnline ? 'Sincronizado (Nuvem)' : 'Modo Offline (Local)';
                }
            }
        };

        // --- INICIALIZA√á√ÉO FIREBASE ---
        if (firebaseConfig.apiKey) {
            try {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase Initialized");
            } catch(e) { console.error("Firebase Init Error", e); }
        }

        let appData = { currentUser: null, users: [], records: {}, irrfTable: [] };
        
        const DEFAULT_IRRF = [
            { id: 'irrf_1', max: 2259.20, rate: 0, deduction: 0 },
            { id: 'irrf_2', max: 2826.65, rate: 7.5, deduction: 169.44 },
            { id: 'irrf_3', max: 3751.05, rate: 15, deduction: 381.44 },
            { id: 'irrf_4', max: 4664.68, rate: 22.5, deduction: 662.77 },
            { id: 'irrf_5', max: 99999999, rate: 27.5, deduction: 896.00 }
        ];

        let currentCrudType = 'products'; 
        let currentListingType = 'clients';
        let currentFinanceFilter = 'all';

        async function init() {
            // Carregamento Ass√≠ncrono via DataManager
            const loadedData = await DataManager.load();
            if (loadedData) appData = loadedData;
            
            if (!appData.irrfTable || appData.irrfTable.length === 0) appData.irrfTable = JSON.parse(JSON.stringify(DEFAULT_IRRF));
            
            const sessionUser = sessionStorage.getItem('mei_user_id');
            if (sessionUser) {
                const user = appData.users.find(u => u.id === sessionUser);
                if (user) { loginUser(user); return; }
            }
            showAuth();
        }

        function showAuth() { document.getElementById('auth-screen').classList.remove('hidden'); document.getElementById('app-container').classList.add('hidden'); }
        
        // Fun√ß√£o de salvamento adaptada para Async
        async function saveData() { 
            await DataManager.save(appData); 
        }

        function loginUser(user) {
            appData.currentUser = user; sessionStorage.setItem('mei_user_id', user.id);
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('user-name-display').innerText = user.name;
            
            // Init Appointments Array if not exists
            if(!appData.records[user.id].appointments) appData.records[user.id].appointments = [];
            
            checkLicense(); navTo('dashboard'); loadFiscalReminders();
            
            // Trigger initial sync attempt
            saveData(); 
        }

        function logout() { appData.currentUser = null; sessionStorage.removeItem('mei_user_id'); location.reload(); }

        function toggleAuth(screen) {
            document.getElementById('login-form').classList.toggle('hidden', screen === 'register');
            document.getElementById('register-form').classList.toggle('hidden', screen !== 'register');
        }

        function handleGoogleLogin() {
            if (!firebaseConfig.apiKey) {
                alert('Simula√ß√£o: Login com Google realizado! (Configure as chaves do Firebase para ativar)');
                return;
            }
            const provider = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithPopup(provider).then((result) => {
                const user = result.user;
                // L√≥gica de integra√ß√£o Google -> AppData Local
                let appUser = appData.users.find(u => u.email === user.email);
                if(!appUser) {
                    appUser = {
                        id: 'u_' + user.uid, 
                        name: user.displayName, 
                        email: user.email, 
                        password: 'google_auth', 
                        licenseExpire: new Date().getTime() + (90 * 86400000),
                        company: { reserve_rate: 10, prolabore_target: 4000 }
                    };
                    appData.users.push(appUser);
                    appData.records[appUser.id] = createSeedData();
                }
                loginUser(appUser);
            }).catch((error) => {
                alert("Erro no login Google: " + error.message);
            });
        }

        function createSeedData() {
            const today = new Date().toISOString().split('T')[0];
            return { 
                products: [{id: 'p_ex', name: 'Produto Exemplo A', price: 100.00, description: 'Produto para teste'}], 
                services: [{id: 's_ex', name: 'Servi√ßo Exemplo B', price: 200.00, description: 'Servi√ßo para teste'}], 
                clients: [{id: 'c_ex', name: 'Cliente Teste', phone: '(11) 99999-9999', address: 'Rua Exemplo, 100', cnpj_cpf: '000.000.000-00', contact_person: 'Jo√£o', email: 'cliente@teste.com'}], 
                suppliers: [{id: 'f_ex', name: 'Fornecedor Teste', phone: '(11) 88888-8888', address: 'Av Exemplo, 200', cnpj_cpf: '00.000.000/0001-00', contact_person: 'Maria', email: 'fornecedor@teste.com'}], 
                transactions: [
                    {id: 't_ex1', type: 'receita', category: 'Venda de produto', value: 150.00, date: today, obs: 'Venda inicial de teste', entity: 'Cliente Teste'},
                    {id: 't_ex2', type: 'despesa', category: 'Despesas Operacionais', value: 50.00, date: today, obs: 'Despesa inicial de teste', entity: 'Fornecedor Teste'}
                ], 
                rpas: [],
                appointments: []
            };
        }

        // --- REGISTRO COM SEED DATA ---
        document.getElementById('register-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('reg-email').value;
            if (appData.users.find(u => u.email === email)) return alert('E-mail j√° existe!');
            
            const newUser = {
                id: 'u_' + Date.now(), name: document.getElementById('reg-name').value, email: email,
                password: document.getElementById('reg-password').value,
                licenseExpire: new Date().getTime() + (90 * 86400000),
                company: { reserve_rate: 10, prolabore_target: 4000 }
            };
            appData.users.push(newUser); 
            appData.records[newUser.id] = createSeedData();
            
            saveData(); loginUser(newUser);
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const user = appData.users.find(u => u.email === document.getElementById('login-email').value && u.password === document.getElementById('login-password').value);
            user ? loginUser(user) : alert('Erro no login');
        });

        function navTo(viewId) {
            document.querySelectorAll('main section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Marca menu ativo
            const btn = Array.from(document.querySelectorAll('.nav-item')).find(el => el.getAttribute('onclick').includes(viewId));
            if(btn) btn.classList.add('active');
            
            if(viewId === 'dashboard') updateDashboard();
            if(viewId === 'listagens') switchListing('clients');
            if(viewId === 'financeiro') renderTransactions();
            if(viewId === 'cadastros') renderCrud(currentCrudType);
            if(viewId === 'agenda') renderAgenda(); // Novo render
            if(viewId === 'fiscal') {
                renderIrrf();
                const comp = appData.currentUser.company || {};
                document.getElementById('link-emissor').href = comp.url_fiscal || DEFAULT_URL_FISCAL;
                document.getElementById('link-das').href = comp.url_das || DEFAULT_URL_DAS;
            }
            if(viewId === 'configuracoes') loadSettings();
            if(viewId === 'rpa') loadRPAOptions();
        }

        // --- Configura√ß√µes ---
        function loadSettings() {
            const c = appData.currentUser.company || {};
            document.getElementById('conf-company-name').value = c.name||''; 
            document.getElementById('conf-cnpj').value = c.cnpj||''; 
            document.getElementById('conf-address').value = c.address||''; 
            document.getElementById('conf-phone').value = c.phone||''; 
            document.getElementById('conf-whatsapp').value = c.whatsapp||'';
            
            document.getElementById('conf-url-fiscal').value = c.url_fiscal || DEFAULT_URL_FISCAL;
            document.getElementById('conf-url-das').value = c.url_das || DEFAULT_URL_DAS;
            
            document.getElementById('conf-reserve-rate').value = c.reserve_rate || 10;
            document.getElementById('conf-prolabore-target').value = c.prolabore_target || 4000;
        }

        function saveCompanyData(e) {
            e.preventDefault();
            
            // Dados da empresa
            const companyData = {
                name: document.getElementById('conf-company-name').value,
                cnpj: document.getElementById('conf-cnpj').value,
                address: document.getElementById('conf-address').value,
                phone: document.getElementById('conf-phone').value,
                whatsapp: document.getElementById('conf-whatsapp').value,
                role: document.getElementById('conf-role').value,
                url_fiscal: document.getElementById('conf-url-fiscal').value,
                url_das: document.getElementById('conf-url-das').value,
                reserve_rate: parseFloat(document.getElementById('conf-reserve-rate').value),
                prolabore_target: parseFloat(document.getElementById('conf-prolabore-target').value)
            };

            appData.currentUser.company = companyData;
            const idx = appData.users.findIndex(u=>u.id===appData.currentUser.id); 
            appData.users[idx] = appData.currentUser; 

            // --- SINCRONIA: Salvar Empresa como Fornecedor ---
            const supplierId = 'sup_own_' + appData.currentUser.id;
            const supplierData = {
                id: supplierId,
                name: companyData.name + " (Minha Empresa)",
                cnpj_cpf: companyData.cnpj,
                phone: companyData.phone,
                address: companyData.address,
                email: appData.currentUser.email,
                contact_person: appData.currentUser.name,
                is_own_company: true
            };
            
            const suppliersList = getUserData().suppliers;
            const supIndex = suppliersList.findIndex(s => s.id === supplierId);
            if(supIndex >= 0) {
                suppliersList[supIndex] = supplierData;
            } else {
                suppliersList.push(supplierData);
            }
            // ------------------------------------------------

            saveData(); alert('Dados salvos e cadastro de fornecedor atualizado!');
        }

        // --- Dashboard ---
        function updateDashboard() {
            const t = getUserData().transactions; 
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const reserveRate = appData.currentUser.company.reserve_rate || 10;
            const prolaboreTarget = appData.currentUser.company.prolabore_target || 4000;

            let income = 0;
            let expense = 0;
            let totalReserve = 0;
            let totalProlabore = 0;

            t.forEach(x => {
                const d = new Date(x.date);
                const isCurrentMonth = d.getMonth() === currentMonth && d.getFullYear() === currentYear;

                if (x.type === 'receita') {
                    if (isCurrentMonth) {
                        income += x.value;
                        const reserveAmount = x.value * (reserveRate / 100);
                        totalReserve += reserveAmount;
                        const remainder = x.value - reserveAmount;
                        const needed = prolaboreTarget - totalProlabore;
                        if (needed > 0) totalProlabore += (remainder >= needed) ? needed : remainder;
                    }
                } else {
                    if (isCurrentMonth) expense += x.value;
                }
            });

            document.getElementById('dash-income').innerText = `R$ ${income.toFixed(2)}`;
            document.getElementById('dash-expense').innerText = `R$ ${expense.toFixed(2)}`;
            document.getElementById('dash-balance').innerText = `R$ ${(income-expense).toFixed(2)}`;
            
            document.getElementById('reserve-percent-display').innerText = reserveRate;
            document.getElementById('dash-reserve').innerText = `R$ ${totalReserve.toFixed(2)}`;
            document.getElementById('dash-prolabore').innerText = `R$ ${totalProlabore.toFixed(2)}`;
            document.getElementById('dash-prolabore-target').innerText = `Meta: R$ ${prolaboreTarget.toFixed(2)}`;
        }

        // --- AGENDA / COMPROMISSOS (NOVO M√ìDULO) ---
        function renderAgenda(filter = '') {
            if(!getUserData().appointments) getUserData().appointments = [];
            let list = getUserData().appointments.sort((a,b) => new Date(a.date+'T'+a.time) - new Date(b.date+'T'+b.time));

            // Filtros de visualiza√ß√£o
            if (filter === 'today') {
                const today = new Date().toISOString().split('T')[0];
                list = list.filter(a => a.date === today);
            } else if (!filter) {
                // Filtro pelo input de data se n√£o for explicitamente 'all' ou 'today'
                const inputDate = document.getElementById('agenda-filter-date').value;
                if(inputDate) list = list.filter(a => a.date === inputDate);
            }

            const container = document.getElementById('agenda-list');
            container.innerHTML = '';

            if (list.length === 0) {
                container.innerHTML = '<p class="text-center p-4" style="grid-column: 1/-1;">Nenhum agendamento encontrado.</p>';
                return;
            }

            const statusMap = {
                'agendado': { label: 'Agendado', class: 'bg-scheduled', card: 'status-agendado' },
                'concluido': { label: 'Conclu√≠do', class: 'bg-done', card: 'status-concluido' },
                'cancelado': { label: 'Cancelado', class: 'bg-canceled', card: 'status-cancelado' }
            };

            list.forEach(a => {
                const st = statusMap[a.status] || statusMap['agendado'];
                const formattedDate = a.date.split('-').reverse().join('/');
                
                const card = document.createElement('div');
                card.className = `stat-card agenda-card ${st.card}`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="badge ${st.class}">${st.label}</span>
                        <div class="text-sm font-bold text-light">${formattedDate} - ${a.time}</div>
                    </div>
                    <h3 class="mb-1">${a.title}</h3>
                    <p class="text-sm mb-1"><strong>Cliente:</strong> ${a.client_name}</p>
                    <p class="text-sm mb-2 text-light">${a.service_desc || 'Sem descri√ß√£o'}</p>
                    
                    <div class="flex justify-between items-center mt-2 border-t pt-2">
                        <div class="text-sm">
                            <span class="${a.pay_status === 'pago' ? 'text-success font-bold' : 'text-warning'}">
                                ${a.pay_status === 'pago' ? 'üí≤ Pago' : '‚è≥ Pendente'}
                            </span>
                             - R$ ${parseFloat(a.value).toFixed(2)}
                        </div>
                        <div>
                            <button class="action-btn btn-warning" onclick="editAppointment('${a.id}')">‚úèÔ∏è</button>
                            <button class="action-btn btn-danger" onclick="deleteAppointment('${a.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function openAppointmentModal(appt = null) {
            document.getElementById('form-appointment').reset();
            const clientSelect = document.getElementById('appt-client-select');
            
            // Popula select de clientes
            clientSelect.innerHTML = '<option value="">Selecionar Cliente Cadastrado...</option>';
            getUserData().clients.forEach(c => {
                clientSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });

            if (appt) {
                document.getElementById('appt-id').value = appt.id;
                document.getElementById('appt-title').value = appt.title;
                document.getElementById('appt-date').value = appt.date;
                document.getElementById('appt-time').value = appt.time;
                document.getElementById('appt-client-name').value = appt.client_name;
                document.getElementById('appt-client-phone').value = appt.client_phone;
                document.getElementById('appt-desc').value = appt.service_desc;
                document.getElementById('appt-value').value = appt.value;
                document.getElementById('appt-status').value = appt.status;
                document.getElementById('appt-pay-method').value = appt.pay_method;
                document.getElementById('appt-pay-status').value = appt.pay_status;
                document.getElementById('appt-obs').value = appt.obs;
            } else {
                document.getElementById('appt-id').value = '';
                document.getElementById('appt-date').valueAsDate = new Date();
                document.getElementById('appt-status').value = 'agendado';
            }

            document.getElementById('modal-appointment').classList.remove('hidden');
        }

        function fillAppointmentClient() {
            const id = document.getElementById('appt-client-select').value;
            if(id) {
                const c = getUserData().clients.find(x => x.id === id);
                if(c) {
                    document.getElementById('appt-client-name').value = c.name;
                    document.getElementById('appt-client-phone').value = c.phone || '';
                }
            }
        }

        function saveAppointment(e) {
            e.preventDefault();
            const id = document.getElementById('appt-id').value;
            const data = {
                id: id || 'appt_' + Date.now(),
                title: document.getElementById('appt-title').value,
                date: document.getElementById('appt-date').value,
                time: document.getElementById('appt-time').value,
                client_name: document.getElementById('appt-client-name').value,
                client_phone: document.getElementById('appt-client-phone').value,
                service_desc: document.getElementById('appt-desc').value,
                value: document.getElementById('appt-value').value || 0,
                status: document.getElementById('appt-status').value,
                pay_method: document.getElementById('appt-pay-method').value,
                pay_status: document.getElementById('appt-pay-status').value,
                obs: document.getElementById('appt-obs').value
            };

            const list = getUserData().appointments;
            if (id) {
                const idx = list.findIndex(x => x.id === id);
                if(idx !== -1) list[idx] = data;
            } else {
                list.push(data);
            }
            
            saveData();
            closeModal('modal-appointment');
            renderAgenda();
        }

        function editAppointment(id) {
            const appt = getUserData().appointments.find(a => a.id === id);
            if(appt) openAppointmentModal(appt);
        }

        function deleteAppointment(id) {
            if(confirm('Excluir este agendamento?')) {
                const list = getUserData().appointments;
                const idx = list.findIndex(a => a.id === id);
                if(idx !== -1) list.splice(idx, 1);
                saveData();
                renderAgenda();
            }
        }

        // --- RPA ---
        function loadRPAOptions() {
            const comp = appData.currentUser.company || {};
            document.getElementById('rpa-comp-name').value = comp.name || '';
            document.getElementById('rpa-comp-cnpj').value = comp.cnpj || '';
            document.getElementById('rpa-comp-addr').value = comp.address || '';
            
            if(!document.getElementById('rpa-prov-name').value) {
                document.getElementById('rpa-prov-name').value = appData.currentUser.name;
            }

            const select = document.getElementById('rpa-provider-select');
            select.innerHTML = '<option value="">Selecione um Aut√¥nomo...</option>';
            const suppliers = getUserData().suppliers || [];
            suppliers.forEach(s => select.innerHTML += `<option value="${s.id}">${s.name}</option>`);
            document.getElementById('rpa-date').valueAsDate = new Date();
            document.getElementById('rpa-id').value = '';
        }

        function fillRPAProvider() {
            const id = document.getElementById('rpa-provider-select').value;
            const s = getUserData().suppliers.find(item => item.id === id);
            if (s) {
                document.getElementById('rpa-prov-name').value = s.name;
                document.getElementById('rpa-prov-cpf').value = s.cnpj_cpf || '';
                document.getElementById('rpa-prov-phone').value = s.phone || '';
                document.getElementById('rpa-prov-addr').value = s.address || '';
            }
        }

        function calculateRPA() {
            const value = parseFloat(document.getElementById('rpa-value').value) || 0;
            const issRate = parseFloat(document.getElementById('rpa-iss-rate').value) || 0;
            const inss = value * 0.11;
            document.getElementById('rpa-inss').value = `R$ ${inss.toFixed(2)}`;
            const iss = value * (issRate / 100);
            document.getElementById('rpa-iss-val').value = `R$ ${iss.toFixed(2)}`;
            
            const irrfBase = value - inss;
            let irrf = 0;
            const table = appData.irrfTable.sort((a,b) => a.max - b.max);
            for(let row of table) {
                if (irrfBase <= row.max) { irrf = (irrfBase * (row.rate / 100)) - row.deduction; break; }
            }
            if (irrf < 0) irrf = 0;
            document.getElementById('rpa-irrf').value = `R$ ${irrf.toFixed(2)}`;
            document.getElementById('rpa-net').value = `R$ ${(value - inss - iss - irrf).toFixed(2)}`;
        }

        function saveRPA() {
            const id = document.getElementById('rpa-id').value;
            const rpa = {
                id: id || 'rpa_' + Date.now(),
                date: document.getElementById('rpa-date').value,
                provider: document.getElementById('rpa-prov-name').value,
                desc: document.getElementById('rpa-desc').value,
                value: document.getElementById('rpa-value').value,
                net: document.getElementById('rpa-net').value,
                fullData: {
                    provName: document.getElementById('rpa-prov-name').value,
                    provCpf: document.getElementById('rpa-prov-cpf').value,
                    provPhone: document.getElementById('rpa-prov-phone').value,
                    provAddr: document.getElementById('rpa-prov-addr').value,
                    inss: document.getElementById('rpa-inss').value,
                    iss: document.getElementById('rpa-iss-val').value,
                    irrf: document.getElementById('rpa-irrf').value
                }
            };
            if(!getUserData().rpas) getUserData().rpas = [];
            const list = getUserData().rpas;
            if(id) { const idx = list.findIndex(r => r.id === id); if(idx !== -1) list[idx] = rpa; else list.push(rpa); } else { list.push(rpa); }
            saveData(); alert('RPA Salvo!'); toggleRPAHistory();
        }

        function toggleRPAHistory() {
            const container = document.getElementById('rpa-history-container');
            container.classList.toggle('hidden');
            if(!container.classList.contains('hidden')) {
                const tbody = document.querySelector('#rpa-history-table tbody');
                tbody.innerHTML = '';
                const list = getUserData().rpas || [];
                list.sort((a,b) => new Date(b.date) - new Date(a.date));
                list.forEach(r => {
                    tbody.innerHTML += `<tr><td>${r.date}</td><td>${r.provider}</td><td>${r.net}</td><td><button class="action-btn btn-warning" onclick="loadRPA('${r.id}')">‚úèÔ∏è</button><button class="action-btn btn-danger" onclick="deleteRPA('${r.id}')">üóëÔ∏è</button></td></tr>`;
                });
            }
        }

        function loadRPA(id) {
            const r = getUserData().rpas.find(x => x.id === id);
            if(r) {
                document.getElementById('rpa-id').value = r.id; 
                document.getElementById('rpa-date').value = r.date;
                document.getElementById('rpa-desc').value = r.desc;
                document.getElementById('rpa-value').value = r.value;
                document.getElementById('rpa-prov-name').value = r.fullData.provName;
                document.getElementById('rpa-prov-cpf').value = r.fullData.provCpf;
                document.getElementById('rpa-prov-phone').value = r.fullData.provPhone;
                document.getElementById('rpa-prov-addr').value = r.fullData.provAddr;
                calculateRPA(); alert('RPA Carregado.'); window.scrollTo(0,0);
            }
        }

        function deleteRPA(id) { if(confirm('Excluir este RPA?')) { const l = getUserData().rpas; l.splice(l.findIndex(r => r.id === id), 1); saveData(); toggleRPAHistory(); } }
        function exportRPAPdf() { document.querySelectorAll('section').forEach(s => s.classList.remove('active-print')); document.getElementById('view-rpa').classList.add('active-print'); window.print(); }
        function exportRPADoc() { const html = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'><head><meta charset='utf-8'><title>RPA</title></head><body><h2 style="text-align:center">RPA - ${appData.currentUser.company.name}</h2><br><h3>1. Contratante</h3><p>Raz√£o: ${document.getElementById('rpa-comp-name').value}</p><p>CNPJ: ${document.getElementById('rpa-comp-cnpj').value}</p><hr><h3>2. Aut√¥nomo</h3><p>Nome: ${document.getElementById('rpa-prov-name').value}</p><p>CPF: ${document.getElementById('rpa-prov-cpf').value}</p><hr><h3>3. Servi√ßo</h3><p>${document.getElementById('rpa-desc').value}</p><p>Data: ${document.getElementById('rpa-date').value}</p><hr><h3>4. Valores</h3><p>Bruto: R$ ${document.getElementById('rpa-value').value}</p><p>L√≠quido: ${document.getElementById('rpa-net').value}</p></body></html>`; const blob = new Blob([html], { type: 'application/msword' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'RPA.doc'; a.click(); }

        // --- Helpers Restantes ---
        function exportReportPDF() { document.getElementById('report-company-header').innerText = appData.currentUser.company.name || "Minha Empresa"; document.querySelectorAll('section').forEach(s => s.classList.remove('active-print')); document.getElementById('view-listagens').classList.add('active-print'); window.print(); }
        function exportReportDoc() { const header = `<h2>${appData.currentUser.company.name || "Minha Empresa"}</h2>`; const table = document.getElementById('listing-table').outerHTML; const html = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'><head><meta charset='utf-8'><title>Relat√≥rio</title></head><body>${header}<h3>Relat√≥rio do Sistema</h3>${table}</body></html>`; const blob = new Blob([html], { type: 'application/msword' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `Relatorio.doc`; a.click(); }
        
        // --- CRUD e CADASTROS (Com Destaque Visual) ---
        function renderCrud(type) { 
            currentCrudType = type; 
            document.getElementById('crud-title').innerText = type.toUpperCase(); 
            
            // Destaque visual nos bot√µes
            document.querySelectorAll('.crud-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('onclick').includes(`'${type}'`));
            });

            const list = getUserData()[type]; 
            const table = document.getElementById('crud-table'); 
            let h = type.match(/products|services/) ? '<th>Nome</th><th>Desc</th><th>Pre√ßo</th>' : '<th>Nome</th><th>Contato</th><th>Info</th>'; 
            table.innerHTML = `<thead><tr>${h}<th>A√ß√µes</th></tr></thead><tbody>` + list.map(i => `<tr><td>${i.name}</td><td>${i.description || i.contact_person || '-'}</td><td>${i.price ? 'R$ '+i.price : i.phone}</td><td><button class="action-btn btn-warning" onclick="editCrudItem('${i.id}')">‚úèÔ∏è</button> <button class="action-btn btn-danger" onclick="deleteCrudItem('${type}','${i.id}')">üóëÔ∏è</button></td></tr>`).join('') + `</tbody>`; 
        }

        function openCrudModal(isEdit = false, itemData = null) { document.getElementById('modal-crud').classList.remove('hidden'); document.getElementById('crud-id').value = itemData ? itemData.id : ''; const fields = document.getElementById('crud-fields'); if(currentCrudType.match(/products|services/)) { fields.innerHTML = `<label>Nome</label><input name="name" value="${itemData?.name||''}" required><label>Pre√ßo</label><input type="number" step="0.01" name="price" value="${itemData?.price||''}" required><label>Descri√ß√£o</label><textarea name="description" rows="3">${itemData?.description||''}</textarea>`; } else { fields.innerHTML = `<label>Nome/Raz√£o</label><input name="name" value="${itemData?.name||''}" required><label>Contato</label><input name="contact_person" value="${itemData?.contact_person||''}"><label>CPF/CNPJ</label><input name="cnpj_cpf" value="${itemData?.cnpj_cpf||''}"><label>Endere√ßo</label><input name="address" value="${itemData?.address||''}"><label>Telefone</label><input name="phone" value="${itemData?.phone||''}"><label>Email</label><input name="email" value="${itemData?.email||''}">`; } }
        function editCrudItem(id) { const item = getUserData()[currentCrudType].find(i => i.id === id); if (item) openCrudModal(true, item); }
        function saveCrudItem(e) { e.preventDefault(); const id = document.getElementById('crud-id').value; const t = e.target; const item = { id: id || 'i_'+Date.now(), name: t.name.value, price: t.price?.value, description: t.description?.value, contact_person: t.contact_person?.value, phone: t.phone?.value, address: t.address?.value, cnpj_cpf: t.cnpj_cpf?.value, email: t.email?.value }; const list = getUserData()[currentCrudType]; const idx = list.findIndex(i => i.id === id); idx !== -1 ? list[idx] = item : list.push(item); saveData(); closeModal('modal-crud'); renderCrud(currentCrudType); }
        function deleteCrudItem(t,id){ if(confirm('Apagar?')){const l=getUserData()[t]; l.splice(l.findIndex(x=>x.id===id),1); saveData(); renderCrud(t);} }
        function getUserData() { return appData.records[appData.currentUser.id]; }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function checkLicense() { const d = Math.ceil((appData.currentUser.licenseExpire - Date.now())/86400000); document.getElementById('license-days-display').innerText = d>0?d+' dias':'Expirado'; document.getElementById('license-warning').classList.toggle('hidden', d>0); }
        function generateLicenseCode() { document.getElementById('license-random-code').value = Math.floor(Math.random()*900)+100; }
        
        function sendWhatsApp() { 
            const code = document.getElementById('license-random-code').value;
            const days = document.getElementById('license-days-input').value;
            window.open(`https://wa.me/5534997824990?text=Cod:${code} Dias:${days}`); 
        }

        // ALTERA√á√ÉO V11.5: Valida√ß√£o usando Constantes
        function validateLicense() { 
            const k = parseInt(document.getElementById('license-key-input').value);
            const c = parseInt(document.getElementById('license-random-code').value);
            const d = parseInt(document.getElementById('license-days-input').value); 
            
            // F√≥rmula Segura
            if(k === (c + LIC_PAD_VAL) * LIC_MULT_FACTOR + LIC_YEAR_BASE + d){
                appData.currentUser.licenseExpire += d * 86400000;
                saveData();
                checkLicense();
                alert('Ok');
            } else {
                alert('Erro'); 
            }
        }
        
        // --- FINANCEIRO (Corre√ß√£o de Filtros e Sele√ß√£o) ---
        function filterFinance(filter) {
            currentFinanceFilter = filter;
            // Destaque visual
            document.querySelectorAll('.fin-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('onclick').includes(`'${filter}'`));
            });
            renderTransactions();
        }

        function renderTransactions(){ 
            let l = getUserData().transactions.sort((a,b)=>new Date(b.date)-new Date(a.date)); 
            
            // Aplica filtro se diferente de 'all'
            if (currentFinanceFilter !== 'all') {
                l = l.filter(t => t.type === currentFinanceFilter);
            }

            document.querySelector('#finance-table tbody').innerHTML = l.length > 0 ? 
                l.map(t=>`<tr><td>${t.date}</td><td>${t.type}</td><td>${t.category}</td><td>${t.obs||'-'}</td><td>R$ ${t.value}</td><td><button onclick="editTransaction('${t.id}')">‚úèÔ∏è</button><button onclick="deleteTransaction('${t.id}')">üóëÔ∏è</button></td></tr>`).join('') :
                '<tr><td colspan="6" class="text-center p-4">Nenhuma movimenta√ß√£o encontrada.</td></tr>';
        }
        
        function editTransaction(id){ 
            const t=getUserData().transactions.find(x=>x.id===id); 
            document.getElementById('trans-id').value=t.id; 
            document.getElementById('trans-type').value=t.type; 
            updateTransactionDependencies(); // Carrega lista de clientes/fornecedores
            document.getElementById('trans-category').value=t.category; 
            document.getElementById('trans-entity').value=t.entity; // Seleciona a entidade correta
            document.getElementById('trans-value').value=t.value; 
            document.getElementById('trans-date').value=t.date; 
            document.getElementById('trans-obs').value=t.obs; 
            document.getElementById('modal-transaction').classList.remove('hidden'); 
        }
        
        function saveTransaction(e){ e.preventDefault(); const id=document.getElementById('trans-id').value; const t={id:id||'t_'+Date.now(), type:document.getElementById('trans-type').value, category:document.getElementById('trans-category').value, value:parseFloat(document.getElementById('trans-value').value), date:document.getElementById('trans-date').value, obs:document.getElementById('trans-obs').value, entity:document.getElementById('trans-entity').value}; const l=getUserData().transactions; const i=l.findIndex(x=>x.id===t.id); i!==-1?l[i]=t:l.push(t); saveData(); closeModal('modal-transaction'); renderTransactions(); }
        function deleteTransaction(id){ if(confirm('Apagar?')){const l=getUserData().transactions; l.splice(l.findIndex(x=>x.id===id),1); saveData(); renderTransactions();} }
        
        function updateTransactionDependencies(){
            const type = document.getElementById('trans-type').value;
            // Categorias
            const cats = type==='receita'?['Venda','Servi√ßo','Outros']:['Compra','Despesa','Imposto', 'Gastos Pessoais']; 
            document.getElementById('trans-category').innerHTML=cats.map(c=>`<option>${c}</option>`).join('');
            
            // Entidades (Corre√ß√£o: Assegura que todas as op√ß√µes estejam dispon√≠veis)
            const select = document.getElementById('trans-entity');
            const list = type === 'receita' ? getUserData().clients : getUserData().suppliers;
            
            if (list && list.length > 0) {
                select.innerHTML = '<option value="">Selecione...</option>' + list.map(i => `<option value="${i.name}">${i.name}</option>`).join('');
            } else {
                select.innerHTML = '<option value="">Sem cadastros dispon√≠veis</option>';
            }
        }
        
        function openTransactionModal(){ 
            document.getElementById('form-transaction').reset(); 
            document.getElementById('trans-id').value=''; 
            document.getElementById('modal-transaction').classList.remove('hidden'); 
            updateTransactionDependencies(); 
        }

        // --- LISTAGEM (Corre√ß√£o Visual) ---
        function switchListing(t){ 
            currentListingType=t; 
            
            // Highlight visual
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('active');
                if(b.getAttribute('onclick').includes(`'${t}'`)) b.classList.add('active');
            });

            document.getElementById('listing-thead').innerHTML=t==='movimentacoes'?'<tr><th>Data</th><th>Tipo</th><th>Valor</th></tr>':'<tr><th>Nome</th><th>Detalhe</th><th>Valor/Tel</th></tr>'; const d=t==='movimentacoes'?getUserData().transactions:getUserData()[t]; document.getElementById('listing-tbody').innerHTML=d.map(i=>t==='movimentacoes'?`<tr><td>${i.date}</td><td>${i.type}</td><td>${i.value}</td></tr>`:`<tr><td>${i.name}</td><td>${i.description||i.contact_person||'-'}</td><td>${i.price||i.phone||'-'}</td></tr>`).join(''); 
        }
        
        function loadFiscalReminders(){ document.getElementById('fiscal-reminders').innerHTML='<li>DAS Dia 20</li>'; }
        function downloadBackup(){ saveData(); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(appData)],{type:'json'})); a.download='backup.json'; a.click(); }
        function restoreBackup(i){ const r=new FileReader(); r.onload=e=>{appData=JSON.parse(e.target.result);saveData();location.reload();}; r.readAsText(i.files[0]); }
        
        // --- IRRF (Edi√ß√£o) ---
        function renderIrrf(){ document.getElementById('irrf-table-body').innerHTML=appData.irrfTable.map(r=>`<tr><td>${r.max}</td><td>${r.rate}</td><td>${r.deduction}</td><td><button class="action-btn btn-warning" onclick="editIrrfRow('${r.id}')">‚úèÔ∏è</button><button class="action-btn btn-danger" onclick="deleteIrrfRow('${r.id}')">X</button></td></tr>`).join(''); }
        function deleteIrrfRow(id){ appData.irrfTable.splice(appData.irrfTable.findIndex(r=>r.id===id),1); saveData(); renderIrrf(); }
        function openIrrfModal(){ document.getElementById('form-irrf').reset(); document.getElementById('irrf-id').value = ''; document.getElementById('modal-irrf').classList.remove('hidden'); }
        function editIrrfRow(id) {
            const row = appData.irrfTable.find(r => r.id === id);
            if(row) {
                document.getElementById('irrf-id').value = row.id;
                document.getElementById('irrf-max').value = row.max;
                document.getElementById('irrf-rate').value = row.rate;
                document.getElementById('irrf-deduction').value = row.deduction;
                document.getElementById('modal-irrf').classList.remove('hidden');
            }
        }
        function saveIrrfRow(e){ 
            e.preventDefault(); 
            const id = document.getElementById('irrf-id').value;
            const data = {
                id: id || 'irrf_'+Date.now(), 
                max:parseFloat(e.target[1].value), 
                rate:parseFloat(e.target[2].value), 
                deduction:parseFloat(e.target[3].value)
            };
            
            if (id) {
                const idx = appData.irrfTable.findIndex(r => r.id === id);
                if (idx !== -1) appData.irrfTable[idx] = data;
            } else {
                appData.irrfTable.push(data); 
            }
            saveData(); closeModal('modal-irrf'); renderIrrf(); 
        }

        init();
    </script>
</body>
</html>